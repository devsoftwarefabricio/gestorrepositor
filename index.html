<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema Alkinda - Gest√£o Completa</title>
    <style>
        /* ========================= RESET E BASE ========================= */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #eef4ff 0%, #e9f7ff 100%);
            padding: 16px;
            color: #213547;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ========================= CARDS E CONTAINERS ========================= */
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,.08);
        }
        
        .login-wrap {
            max-width: 520px;
            margin: 36px auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .logo img {
            height: 78px;
            object-fit: contain;
        }

        /* ========================= TIPOGRAFIA ========================= */
        h1 {
            font-size: 20px;
            color: #0b3b66;
            margin-bottom: 12px;
        }
        
        .card-title {
            font-weight: 700;
            color: #163d67;
            margin-bottom: 10px;
        }

        /* ========================= BOT√ïES ========================= */
        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .btn {
            padding: 12px 14px;
            border-radius: 10px;
            border: 0;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-gestor {
            background: #163d67;
            color: #fff;
        }
        
        .btn-repositor {
            background: linear-gradient(90deg, #56CCF2, #2F80ED);
            color: #fff;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }
        
        .btn-primary {
            background: #2F80ED;
            color: #fff;
        }
        
        .btn-danger {
            background: #dc3545;
            color: #fff;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #213547;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 6px;
        }

        /* ========================= HEADER ========================= */
        .header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }
        
        .header-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .header-title {
            font-weight: 800;
            color: #163d67;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .select-funcionario {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #cfeefc;
        }
        
        .btn-sair {
            background: #ff6b6b;
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
        }

        /* ========================= GRID E CART√ïES ========================= */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 14px;
        }
        
        .stat {
            padding: 18px;
            border-radius: 10px;
            background: #fff;
        }
        
        .stat .value {
            font-size: 28px;
            font-weight: 800;
            color: #163d67;
        }

        /* ========================= MAPA DE SETORES ========================= */
        .setor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            border-left: 6px solid #56CCF2;
            background: #fbfeff;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .setor-item:hover {
            background: #f0f8ff;
            transform: translateX(4px);
        }
        
        .setor-falta {
            border-left-color: #dc3545;
            background: linear-gradient(180deg, #fff5f5, #fff8f8);
        }
        
        .setor-ok {
            border-left-color: #28a745;
        }
        
        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
        }

        /* ========================= MODAIS ========================= */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            z-index: 2000;
            overflow: auto;
            padding: 22px;
        }
        
        .modal .modal-inner {
            max-width: 720px;
            margin: 30px auto;
            background: #fff;
            padding: 18px;
            border-radius: 12px;
        }
        
        .form-group {
            margin: 10px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #435d73;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 9px;
            border-radius: 8px;
            border: 1px solid #e6eef8;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2F80ED;
        }
        
        /* Lista de Itens (Nova) */
        .item-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .item-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fbff;
            border-radius: 8px;
            margin-bottom: 6px;
        }
        .item-list-actions {
            display: flex;
            gap: 6px;
        }
        
        /* Modal Config (UX/UI) */
        .config-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }
        .config-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            border-radius: 12px;
            background: #f8fbff;
            border: 1px solid #eef5fb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .config-menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.05);
            border-color: #2F80ED;
        }
        .config-menu-item .icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        .config-menu-item .title {
            font-size: 16px;
            font-weight: 700;
            color: #163d67;
        }
        .config-menu-item .description {
            font-size: 13px;
            color: #6b7d8a;
            text-align: center;
            margin-top: 4px;
        }


        /* ========================= INFORMATIVOS ========================= */
        .informativo-item {
            background: linear-gradient(135deg, #fff3cd, #fff8d6);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        /* ========================= HIST√ìRICO DE OCORR√äNCIAS ========================= */
        .historico-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 6px solid #6c757d; /* Padr√£o/Observacao */
            background: #f8f9fa;
        }
        .historico-item.executado {
            border-left-color: #28a745; /* Verde */
            background: #f0fff3;
        }
        .historico-item.nao_executado {
            border-left-color: #dc3545; /* Vermelho */
            background: #fff5f5;
        }

        /* ========================= NOTIFICA√á√ïES ========================= */
        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #fff;
            padding: 10px 14px;
            border-left: 6px solid #28a745;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,.12);
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ========================= TABELAS / RELAT√ìRIO ========================= */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .table th, .table td {
            padding: 8px;
            border-bottom: 1px solid #eef5fb;
            text-align: left;
        }
        
        .table th {
            background: #f8fbff;
            font-weight: 700;
            color: #163d67;
        }
        
        /* NOVO: Tabela de Escala */
        .escala-table { width: 100%; border-collapse: collapse; }
        .escala-table th, .escala-table td { 
            padding: 8px; 
            text-align: left; 
            border-bottom: 1px solid #eef5fb; 
        }
        .escala-table th { background: #f8fbff; color: #163d67; font-size: 13px; }
        .escala-table td { font-size: 14px; }
        .escala-table td.folga { font-weight: 700; color: #dc3545; background: #fff5f5; }

        /* ========================= FEEDBACK VISUAL ========================= */
        .feedback-resolvido {
            background: #d4edda;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #28a745;
        }
        
        .feedback-pendente {
            background: #fff3cd;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #ffc107;
        }

        
        /* ========================= RESPONSIVO - Mobile First ========================= */
        
        /* *
         * BLOCO DE C√ìDIGO ATUALIZADO (IN√çCIO)
         * O bloco abaixo foi modificado para incluir seus ajustes de responsivo.
         *
        */
        @media(max-width:780px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            /* Ajuste para centralizar o logo no mobile */
            .logo {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .logo img {
                height: 54px;
            }
            
            .login-wrap {
                margin: 18px auto; /* Ajustado para centralizar o card */
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            
            .select-funcionario {
                width: 100%;
            }
            
            .btn-sair {
                width: 100%;
            }
        }
        /* *
         * BLOCO DE C√ìDIGO ATUALIZADO (FIM)
         *
        */
        
        
        @media(max-width:480px) {
            body {
                padding: 8px;
            }
            
            .card {
                padding: 12px;
            }
            
            .stat .value {
                font-size: 22px;
            }
            
            .modal-inner {
                padding: 12px;
            }
            
            .config-menu {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>
<div class="container">
    <script>const LOGO_PATH = './logo.jpeg';</script>
    
    <div id="loginBox" class="login-wrap card">
        <div class="logo">
            <img id="logoImg" src="" alt="Logo Alkinda" onerror="this.style.display='none'" />
            <div>
                <h1>ALKINDA ‚Äì Sistema de Gest√£o</h1>
                <div style="font-size:13px;color:#6b7d8a">Acesse como Gestor ou Repositor</div>
            </div>
        </div>

        <div style="margin-top:12px">
            <label style="font-weight:700">Selecione o tipo de acesso:</label>
            <div class="buttons">
                <button class="btn btn-gestor" onclick="abrirLogin('gestor')">üîí Gestor</button>
                <button class="btn btn-repositor" onclick="abrirLogin('repositor')">üì¶ Repositor</button>
            </div>
        </div>

        <div id="loginForm" style="margin-top:14px;display:none">
            <div class="form-group">
                <label>Usu√°rio</label>
                <input id="loginUser" placeholder="Digite seu nome de usu√°rio" autocomplete="username">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input id="loginPass" type="password" placeholder="Digite sua senha" autocomplete="current-password">
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <button class="btn btn-gestor" onclick="fazerLogin()">Entrar</button>
                <button class="btn btn-secondary" onclick="fecharLogin()">Cancelar</button>
            </div>
            <div style="margin-top:12px;padding:10px;background:#fff3cd;border-radius:8px;font-size:12px;color:#856404">
                <strong>‚ö†Ô∏è Seguran√ßa:</strong> As senhas s√£o verificadas localmente (localStorage). 
                Para seguran√ßa real em produ√ß√£o, implemente autentica√ß√£o no servidor.
            </div>
        </div>

        </div>

    <div id="mainScreen" style="display:none">
        <div class="header card">
            <div class="header-left">
                <img id="headerLogo" src="" style="height:46px;object-fit:contain" alt="Logo" />
                <div class="header-title" id="tituloSistema">Sistema de Gest√£o</div>
            </div>
            <div class="header-actions">
                <div id="selectFuncionarioDiv" style="display:none">
                    <select id="selectFuncionario" class="select-funcionario">
                        <option value="">Selecione seu nome</option>
                    </select>
                </div>
                <button class="btn-sair" onclick="sair()">üö™ Sair</button>
            </div>
        </div>

        <div id="dashboardGestor" style="display:none">
            <div class="grid" style="margin-bottom:12px">
                <div class="stat card">
                    <div class="card-title">Reposi√ß√µes Hoje</div>
                    <div class="value" id="totalReposicoes">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Perdas/Vencidos</div>
                    <div class="value" id="totalPerdas">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Setores em Alerta</div>
                    <div class="value" id="setoresAlerta">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Total de Setores</div>
                    <div class="value" id="totalSetores">0</div>
                </div>
            </div>

            <div class="card" style="margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                    <div><strong>üìä Filtros & A√ß√µes</strong></div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-gestor" onclick="abrirModalConfiguracoes()">‚öôÔ∏è Configura√ß√µes</button>
                        <button class="btn btn-repositor" onclick="exportarRelatorioCSV()">üì• CSV</button>
                        <button class="btn btn-primary" onclick="exportarBackupJSON()">üíæ Backup</button>
                        <button class="btn btn-secondary" onclick="importarBackupJSON()">üì§ Restaurar</button>
                        <button class="btn btn-primary" onclick="gerarPDF()">üìÑ PDF</button>
                        <button class="btn btn-gestor" onclick="abrirModalInformativo()">üì¢ Informativo</button>
                        <button class="btn btn-danger" onclick="resetarSistema()">üîÑ Resetar Sistema</button>
                    </div>
                </div>
                <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                    <input type="date" id="filtroData" style="padding:8px;border-radius:8px;border:1px solid #e6eef8" />
                    <select id="filtroSetor" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
                        <option value="">Todos os Setores</option>
                    </select>
                    <button class="btn btn-primary" onclick="aplicarFiltros()">üîç Filtrar</button>
                    <button class="btn btn-secondary" onclick="limparFiltros()">üîÑ Limpar</button>
                </div>
            </div>

            <div class="card" style="margin-bottom:12px">
                <div class="card-title">‚ö†Ô∏è Central de Perdas e Vencidos</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
                    <div style="flex:1"><strong>Total:</strong> <span id="totalPerdasGeral">0</span></div>
                    <div style="flex:1"><strong>Vencidos:</strong> <span id="totalVencidos">0</span></div>
                    <div style="flex:1"><strong>Avariados:</strong> <span id="totalAvariados">0</span></div>
                    <div style="flex:1"><strong>Quebras:</strong> <span id="totalQuebras">0</span></div>
                </div>
                <div id="listaPerdasDetalhada"></div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-title">üó∫Ô∏è Mapa de Setores</div>
                    <div id="mapaSetores"></div>
                </div>
                <div class="card">
                    <div class="card-title">üì¶ Reposi√ß√µes</div>
                    <div id="listaReposicoes"></div>
                </div>
                <div class="card">
                    <div class="card-title">üë• Por Repositor</div>
                    <div id="relatorioRepositor"></div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
                    <div class="card-title">üì¢ Informativos Enviados</div>
                    <button class="btn btn-primary" onclick="abrirModalInformativo()">üì§ Enviar Novo</button>
                </div>
                <div id="listaInformativos"></div>
            </div>
            
            <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
                    <div class="card-title">üîÅ Hist√≥rico de Ocorr√™ncias (Handoff)</div>
                    <button class="btn btn-primary" onclick="abrirModalHistorico()">‚úçÔ∏è Registrar Novo</button>
                </div>
                <div id="listaHistoricoServicos"></div>
            </div>
            
        </div>

        <div id="dashboardRepositor" style="display:none">
            <div class="card">
                <div class="card-title">üè™ Meu Setor: <span id="meuSetor" style="color:#2F80ED"></span></div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-repositor" onclick="abrirModalReposicao()">‚úÖ Registrar Reposi√ß√£o</button>
                    <button class="btn btn-primary" onclick="abrirModalPerda()">‚ö†Ô∏è Registrar Perda/Vencido</button>
                    <button class="btn btn-gestor" onclick="registrarFalta()">üö® Produto em Falta</button>
                </div>
            </div>

            <div class="grid" style="margin-top:12px">
                <div class="stat card">
                    <div class="card-title">Reposi√ß√µes Hoje</div>
                    <div class="value" id="minhasReposicoesHoje">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Perdas Hoje</div>
                    <div class="value" id="minhasPerdasHoje">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Faltas Reportadas</div>
                    <div class="value" id="minhasFaltasAbertas">0</div>
                </div>
            </div>
            
            <div class="card" style="margin-top:12px">
                <div class="card-title">üóìÔ∏è Minha Escala Semanal</div>
                <div id="minhaEscala"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">üìã Meus Registros Hoje</div>
                <div id="minhasReposicoes"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">üîî Meus Alertas de Falta - Feedback do Gestor</div>
                <div id="minhasFaltasComFeedback"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">üì¢ Informativos</div>
                <div id="informativosRepositor"></div>
            </div>
        </div>
    </div>

</div>

<div id="modalReposicao" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚úÖ Registrar Reposi√ß√£o</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalReposicao')">‚úñ Fechar</button>
        </div>
        <div class="form-group">
            <label style="font-weight:700">üîç Escolha como deseja identificar o produto:</label>
            <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
                <label style="cursor:pointer;padding:8px;background:#f8fbff;border-radius:6px">
                    <input type="radio" name="buscaTipo" value="codBarras" checked onchange="alterarTipoBusca()"> 
                    üìä C√≥digo de Barras
                </label>
                <label style="cursor:pointer;padding:8px;background:#f8fbff;border-radius:6px">
                    <input type="radio" name="buscaTipo" value="codProduto" onchange="alterarTipoBusca()"> 
                    üè∑Ô∏è C√≥digo do Produto
                </label>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>üìä C√≥digo de Barras</label>
                <input id="inputCodBarras" placeholder="Digite ou escaneie o c√≥digo" autocomplete="off">
            </div>
            <div class="form-group">
                <label>üè∑Ô∏è C√≥digo do Produto</label>
                <input id="inputCodProduto" placeholder="C√≥digo interno do produto" autocomplete="off" disabled>
            </div>
        </div>
        <div class="form-group">
            <label>üì¶ Nome do Produto *</label>
            <input id="inputProduto" placeholder="Ex: Arroz Tio Jo√£o 5kg" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>üìä Quantidade *</label>
                <input id="inputQuantidade" type="number" min="1" placeholder="Ex: 10" required>
            </div>
            <div class="form-group">
                <label>üìÖ Data Fabrica√ß√£o</label>
                <input id="inputDataFabricacao" type="date">
            </div>
            <div class="form-group">
                <label>‚è∞ Data Validade</label>
                <input id="inputDataValidade" type="date">
            </div>
        </div>
        <div class="form-group">
            <label>‚ö†Ô∏è Avaria</label>
            <select id="inputAvaria">
                <option value="nao">‚úÖ Sem Avaria</option>
                <option value="embalagem">üì¶ Embalagem Danificada</option>
                <option value="produto">üîß Produto Avariado</option>
            </select>
        </div>
        <div class="form-group">
            <label>üìù Observa√ß√µes</label>
            <textarea id="inputObservacao" rows="3" placeholder="Informa√ß√µes adicionais sobre a reposi√ß√£o..."></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn btn-repositor" onclick="salvarReposicao()">üíæ Salvar Reposi√ß√£o</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalReposicao')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalPerda" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚ö†Ô∏è Registrar Perda/Vencido</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalPerda')">‚úñ Fechar</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>üìä C√≥digo de Barras</label>
                <input id="inputCodBarrasPerda" placeholder="Opcional">
            </div>
            <div class="form-group">
                <label>üì¶ Nome do Produto *</label>
                <input id="inputProdutoPerda" placeholder="Ex: Leite Vencido" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>‚ö†Ô∏è Tipo *</label>
                <select id="inputTipoPerda">
                    <option value="vencido">‚è∞ Vencido</option>
                    <option value="avariado">üîß Avariado</option>
                    <option value="quebra">üíî Quebra</option>
                </select>
            </div>
            <div class="form-group">
                <label>üìä Quantidade *</label>
                <input id="inputQuantidadePerda" type="number" min="1" placeholder="Ex: 5" required>
            </div>
        </div>
        <div class="form-group">
            <label>üìù Motivo *</label>
            <textarea id="inputMotivoPerda" rows="3" placeholder="Descreva o motivo da perda..." required></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="salvarPerda()">üíæ Salvar Perda</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalPerda')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalInformativo" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üì¢ Enviar Informativo</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalInformativo')">‚úñ Fechar</button>
        </div>
        <div class="form-group">
            <label>üìã T√≠tulo *</label>
            <input id="inputTituloInfo" placeholder="Ex: Reuni√£o de Equipe" required>
        </div>
        <div class="form-group">
            <label>üìù Mensagem *</label>
            <textarea id="inputMensagemInfo" rows="6" placeholder="Digite a mensagem do informativo..." required></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="enviarInformativo()">üì§ Enviar</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalInformativo')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalDetalhesSetor" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 id="tituloDetalhesSetor">Detalhes do Setor</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalDetalhesSetor')">‚úñ Fechar</button>
        </div>
        <div id="conteudoDetalhesSetor"></div>
    </div>
</div>

<div id="modalConfiguracoes" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚öôÔ∏è Configura√ß√µes do Sistema</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalConfiguracoes')">‚úñ Fechar</button>
        </div>
        <p style="margin-bottom:16px;color:#435d73">Gerencie os dados mestres do sistema.</p>
        
        <div class="config-menu">
            <div class="config-menu-item" onclick="abrirModalFuncionarios()">
                <div class="icon">üßë‚Äçüíº</div>
                <div class="title">Gerenciar Funcion√°rios</div>
                <div class="description">Cadastre e edite os funcion√°rios da loja.</div>
            </div>
            
            <div class="config-menu-item" onclick="abrirModalSetores()">
                <div class="icon">üè™</div>
                <div class="title">Gerenciar Setores</div>
                <div class="description">Crie setores e atribua seus respons√°veis.</div>
            </div>
            
            <div class="config-menu-item" onclick="abrirModalUsuarios()">
                <div class="icon">üîë</div>
                <div class="title">Gerenciar Acessos (Usu√°rios)</div>
                <div class="description">Crie e remova logins para os funcion√°rios.</div>
            </div>
            
            <div class="config-menu-item" onclick="abrirModalEscalas()">
                <div class="icon">üóìÔ∏è</div>
                <div class="title">Gerenciar Escalas</div>
                <div class="description">Defina hor√°rios e folgas dos funcion√°rios.</div>
            </div>
        </div>
    </div>
</div>

<div id="modalFuncionarios" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üßë‚Äçüíº Gerenciar Funcion√°rios</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalFuncionarios'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>
        
        <div style="padding:14px;background:#f8fbff;border-radius:10px;margin-bottom:16px">
            <h4 style="color:#163d67;margin-bottom:10px" id="formTituloFuncionario">‚ûï Adicionar Novo Funcion√°rio</h4>
            <input type="hidden" id="inputFuncionarioId">
            <div class="form-row">
                <div class="form-group">
                    <label>üë§ Nome * (Usar mai√∫sculas, ex: JOAO)</label>
                    <input id="inputFuncionarioNome" placeholder="Ex: JOAO" required>
                </div>
                <div class="form-group">
                    <label>üìã Cargo *</label>
                    <input id="inputFuncionarioCargo" placeholder="Ex: Repositor" required>
                </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="salvarFuncionario()">üíæ Salvar</button>
                <button class="btn btn-secondary" onclick="limparFormulario('funcionario')" style="display:none;" id="btnLimparFuncionario">Cancelar Edi√ß√£o</button>
            </div>
        </div>
        
        <div>
            <h4 style="color:#163d67;margin-bottom:10px">üìã Funcion√°rios Atuais</h4>
            <div id="listaFuncionarios" class="item-list">
                </div>
        </div>
    </div>
</div>

<div id="modalSetores" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üè™ Gerenciar Setores</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalSetores'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>
        
        <div style="padding:14px;background:#f8fbff;border-radius:10px;margin-bottom:16px">
            <h4 style="color:#163d67;margin-bottom:10px" id="formTituloSetor">‚ûï Adicionar Novo Setor</h4>
            <input type="hidden" id="inputSetorId">
            <div class="form-row">
                <div class="form-group">
                    <label>üè™ Nome do Setor *</label>
                    <input id="inputSetorNome" placeholder="Ex: HORTIFRUTI" required>
                </div>
                <div class="form-group">
                    <label>üë§ Respons√°vel *</label>
                    <select id="inputSetorResponsavel">
                        <option value="">Selecione um funcion√°rio...</option>
                        </select>
                </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="salvarSetor()">üíæ Salvar</button>
                <button class="btn btn-secondary" onclick="limparFormulario('setor')" style="display:none;" id="btnLimparSetor">Cancelar Edi√ß√£o</button>
            </div>
        </div>
        
        <div>
            <h4 style="color:#163d67;margin-bottom:10px">üè™ Setores Atuais</h4>
            <div id="listaSetores" class="item-list">
                </div>
        </div>
    </div>
</div>

<div id="modalUsuarios" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üîë Gerenciar Acessos (Usu√°rios)</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalUsuarios'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>

        <div style="padding:14px;background:#f8fbff;border-radius:10px;margin-bottom:16px">
            <h4 style="color:#163d67;margin-bottom:10px">‚ûï Adicionar Novo Acesso</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>üë§ Nome de Usu√°rio * (Deve ser um funcion√°rio j√° cadastrado)</label>
                    <select id="inputUsuarioNovoNome">
                        <option value="">Selecione um funcion√°rio...</option>
                        </select>
                </div>
                <div class="form-group">
                    <label>üîë Senha *</label>
                    <input id="inputSenhaNova" type="password" placeholder="M√≠nimo 6 caracteres" required>
                </div>
            </div>
            <button class="btn btn-primary" onclick="salvarNovoUsuario()">üíæ Salvar Acesso</button>
        </div>

        <div>
            <h4 style="color:#163d67;margin-bottom:10px">üìã Acessos Atuais</h4>
            <div id="listaUsuariosAtual" class="item-list">
                </div>
        </div>
    </div>
</div>

<div id="modalHistorico" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚úçÔ∏è Registrar Ocorr√™ncia/Servi√ßo</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalHistorico')">‚úñ Fechar</button>
        </div>
        <div class="form-group">
            <label>üìã Tipo de Registro *</label>
            <select id="inputHistoricoTipo">
                <option value="executado">‚úÖ Servi√ßo Executado / Resolvido</option>
                <option value="nao_executado">‚ö†Ô∏è Servi√ßo N√£o Executado / Pendente</option>
                <option value="observacao">‚ÑπÔ∏è Observa√ß√£o / Handoff</option>
            </select>
        </div>
        <div class="form-group">
            <label>üìù Descri√ß√£o * (O que foi feito ou o que est√° pendente?)</label>
            <textarea id="inputHistoricoDescricao" rows="6" placeholder="Ex: A c√¢mara fria foi verificada... Ex: Faltou fazer a contagem do dep√≥sito..." required></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="salvarHistoricoServico()">üíæ Salvar Registro</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalHistorico')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalEscalas" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üóìÔ∏è Gerenciar Escalas</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalEscalas'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>
        
        <div class="form-group">
            <label>üë§ Selecione o Funcion√°rio *</label>
            <select id="selectFuncionarioEscala" onchange="carregarEscalaFuncionario(this.value)">
                <option value="">Selecione um funcion√°rio...</option>
            </select>
        </div>
        
        <div id="formEscala" style="display:none; padding:14px; background:#f8fbff; border-radius:10px; margin-top:16px;">
            <h4 style="color:#163d67; margin-bottom:10px">Definir Hor√°rios (Ex: 08:00-17:00, FOLGA, N/A)</h4>
            <div class="form-row" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                <div class="form-group">
                    <label>Domingo</label>
                    <input id="inputEscalaDom" placeholder="Ex: FOLGA">
                </div>
                <div class="form-group">
                    <label>Segunda</label>
                    <input id="inputEscalaSeg" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Ter√ßa</label>
                    <input id="inputEscalaTer" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Quarta</label>
                    <input id="inputEscalaQua" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Quinta</label>
                    <input id="inputEscalaQui" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Sexta</label>
                    <input id="inputEscalaSex" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>S√°bado</label>
                    <input id="inputEscalaSab" placeholder="Ex: 08:00-12:00">
                </div>
            </div>
            <button class="btn btn-primary" onclick="salvarEscalaFuncionario()">üíæ Salvar Escala</button>
        </div>
    </div>
</div>


<script>
/* ======================================================================================
SISTEMA ALKINDA - JAVASCRIPT (v3.2 - Gest√£o de Escalas)
======================================================================================
- ARQUITETURA ATUALIZADA: Setores e Funcion√°rios agora s√£o din√¢micos (localStorage).
- GEST√ÉO COMPLETA: Gestor pode criar, editar e excluir funcion√°rios, setores e acessos.
- NOVO (v3.1): Hist√≥rico de Ocorr√™ncias (Handoff) para Gerentes.
- NOVO (v3.2): Gest√£o de Escalas (Hor√°rios) de funcion√°rios.
======================================================================================
*/

/* ========================= CONFIGURA√á√ÉO INICIAL ========================= */

// CHAVES DO LOCALSTORAGE (Padronizadas)
const K = {
    FUNCIONARIOS: 'alkinda_funcionarios',
    SETORES: 'alkinda_setores',
    USUARIOS: 'alkinda_usuarios',
    REPOSICOES: 'alkinda_reposicoes',
    PERDAS: 'alkinda_perdas',
    FALTAS: 'alkinda_faltas',
    INFORMATIVOS: 'alkinda_informativos',
    HISTORICO_SERVICOS: 'alkinda_historico',
    ESCALAS: 'alkinda_escalas' // NOVO
};

// DADOS DE INICIALIZA√á√ÉO (Padr√£o para primeiro uso)
const DADOS_INICIAIS = {
    funcionarios: [
        {id: 1, nome:'PRICILA', cargo:'REPOSITOR'},
        {id: 2, nome:'JONATA', cargo:'REPOSITOR'},
        {id: 3, nome:'SAMUEL', cargo:'REPOSITOR'},
        {id: 4, nome:'SAMARA', cargo:'REPOSITOR'},
        {id: 5, nome:'HUGO', cargo:'REPOSITOR'},
        {id: 6, nome:'THIAGO', cargo:'REPOSITOR'},
        {id: 7, nome:'JOESON', cargo:'REPOSITOR'},
        {id: 8, nome:'VANDERSON', cargo:'REPOSITOR'},
        {id: 9, nome:'JOAO', cargo:'REPOSITOR / ENTREGADOR'},
        {id: 10, nome:'MARCIO', cargo:'REPOSITOR / ENTREGADOR'},
        {id: 11, nome:'SAMIRA', cargo:'FRENTE DE LOJA'},
        {id: 12, nome:'CARLINHOS', cargo:'SUBGERENTE'},
        {id: 13, nome:'GERENTE', cargo:'GERENTE'},
        {id: 14, nome:'ADMIN', cargo:'GESTOR'}
    ],
    setores: [
        {id: 1, nome:'PERFUMARIA / BAZAR', responsavel_nome:'PRICILA'},
        {id: 2, nome:'BISCOITO / LEITE', responsavel_nome:'JONATA'},
        {id: 3, nome:'CEREAL / BEBIDA', responsavel_nome:'SAMUEL'},
        {id: 4, nome:'PANIFICADORA/DESCART√ÅVEL', responsavel_nome:'SAMARA'},
        {id: 5, nome:'LIMPEZA', responsavel_nome:'HUGO'},
        {id: 6, nome:'FRUTAS / FRIOS', responsavel_nome:'THIAGO'}, // Apenas o primeiro para simplificar
        {id: 7, nome:'TEMPERO / MASSAS', responsavel_nome:'JOAO'}, // Apenas o primeiro
        {id: 8, nome:'FRENTE DE LOJA', responsavel_nome:'AGUARDANDO'},
        {id: 9, nome:'PAPELARIA', responsavel_nome:'SAMIRA'},
        {id: 10, nome:'SUBGER√äNCIA', responsavel_nome:'CARLINHOS'},
        {id: 11, nome:'GER√äNCIA', responsavel_nome:'GERENTE'}
    ]
};

// Vari√°veis globais de dados
let reposicoes = [];
let perdas = [];
let faltasGondola = [];
let informativos = [];
let usuariosHash = {};
let funcionarios = [];
let setores = [];
let historicoServicos = []; 
let escalas = {}; // NOVO

// Estado da sess√£o
let tipoUsuario = '';
let funcionarioAtual = '';
let intervalAtualizacao = null;


/* ========================= FUN√á√ïES UTILIT√ÅRIAS ========================= */

function mostrarNotificacao(msg, tipo='success'){
    const div = document.createElement('div'); 
    div.className='notification '+(tipo==='error'?'error':'');
    div.innerHTML = (tipo==='error'?'<strong>‚ùå</strong> ':'<strong>‚úÖ</strong> ')+
                    `<span style="margin-left:8px">${msg}</span>`;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),3500);
}

async function hashString(str){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const arr = Array.from(new Uint8Array(hash));
    return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function setPassword(user,newPass){
    if(!user || !newPass){
        console.error('‚ùå Forne√ßa usu√°rio e senha v√°lidos');
        mostrarNotificacao('Forne√ßa usu√°rio e senha v√°lidos', 'error');
        return;
    }
    carregarDadosGlobais();
    usuariosHash[user.toUpperCase()] = await hashString(newPass);
    localStorage.setItem(K.USUARIOS, JSON.stringify(usuariosHash));
    mostrarNotificacao(`‚úÖ Senha atualizada para: ${user}`, 'success');
    console.log(`‚úÖ Senha do usu√°rio '${user}' alterada com sucesso!`);
}

function sanitize(str){
    if(!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function resetarSistema(){
    if(confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso apagar√° TODOS os registros (reposi√ß√µes, perdas, faltas, hist√≥ricos, escalas) e redefinir√° os funcion√°rios, setores e usu√°rios para o padr√£o.\n\nGESTOR: admin / gestor123\nREPOSITOR: (nome) / rep123\n\nDeseja continuar?')){
        // Apaga todas as chaves
        Object.values(K).forEach(key => localStorage.removeItem(key));
        mostrarNotificacao('üîÑ Sistema resetado. A p√°gina ser√° recarregada.');
        setTimeout(()=> location.reload(), 2000);
    }
}


/* ========================= LOGIN E AUTENTICA√á√ÉO ========================= */

// Carrega logo
document.getElementById('logoImg').src = LOGO_PATH;
document.getElementById('headerLogo').src = LOGO_PATH;

function abrirLogin(tipo){
    tipoUsuario = tipo;
    document.getElementById('loginForm').style.display = 'block';
    
    if(tipo === 'gestor'){
        document.getElementById('loginUser').value = 'admin';
    } else {
        document.getElementById('loginUser').value = '';
    }
    
    document.getElementById('loginPass').value = '';
    document.getElementById('loginUser').focus();
    
    const usuariosAtivos = Object.keys(usuariosHash);
    if(usuariosAtivos.length > 0){
        console.log('üë• Usu√°rios dispon√≠veis:', usuariosAtivos.join(', '));
    }
}

function fecharLogin(){ 
    document.getElementById('loginForm').style.display='none'; 
}

async function fazerLogin(){
    const user = document.getElementById('loginUser').value.trim().toUpperCase();
    const pass = document.getElementById('loginPass').value;
    
    if(!user || !pass){ 
        mostrarNotificacao('Preencha usu√°rio e senha','error'); 
        return; 
    }
    
    // Carrega dados (usu√°rios j√° foram garantidos no init)
    carregarDadosGlobais();
    
    const userKeys = Object.keys(usuariosHash);
    const foundUser = userKeys.find(u => u.toUpperCase() === user);
    
    if(!foundUser){
        mostrarNotificacao('Usu√°rio n√£o encontrado. Tente: admin ou seu nome','error');
        console.log('üë• Usu√°rios dispon√≠veis:', userKeys.join(', '));
        return;
    }
    
    const hash = await hashString(pass);
    if(usuariosHash[foundUser] === hash){
        funcionarioAtual = foundUser;
        iniciarSessao();
        mostrarNotificacao('‚úÖ Login realizado com sucesso!');
    } else {
        mostrarNotificacao('Senha incorreta','error');
    }
}

/* ========================= GEST√ÉO DE SESS√ÉO ========================= */

function iniciarSessao(){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('mainScreen').style.display='block';
    document.getElementById('loginForm').style.display='none';

    // Carrega todos os dados (setores, funcion√°rios, etc.)
    carregarDadosGlobais();

    if(tipoUsuario==='gestor'){
        document.getElementById('tituloSistema').textContent = 'üîê Painel do Gestor ('+funcionarioAtual+')';
        document.getElementById('dashboardGestor').style.display='block';
        carregarDashboardGestor();
        intervalAtualizacao = setInterval(carregarDashboardGestor, 3000);
    } else {
        document.getElementById('tituloSistema').textContent = 'üì¶ Painel do Repositor';
        document.getElementById('selectFuncionarioDiv').style.display = 'block';
        carregarSelectFuncionarios();
    }
}

/*
   CarregarSelectFuncionarios: Popula lista de repositores (AGORA DIN√ÇMICO)
*/
function carregarSelectFuncionarios(){
    const select = document.getElementById('selectFuncionario');
    select.innerHTML = '<option value="">Selecione seu nome</option>';
    
    // Filtra funcion√°rios que possuem um login (est√£o em usuariosHash)
    const repositoresComAcesso = funcionarios.filter(f => usuariosHash[f.nome.toUpperCase()]);

    repositoresComAcesso.forEach(func => {
        // Encontra o setor desse funcion√°rio
        const setorInfo = setores.find(s => s.responsavel_nome.toUpperCase() === func.nome.toUpperCase());
        const nomeSetor = setorInfo ? setorInfo.nome : 'Sem Setor';
        
        if(func.nome !== 'ADMIN') {
            select.innerHTML += `<option value="${func.nome.toUpperCase()}">${func.nome} - ${nomeSetor}</option>`;
        }
    });
    
    select.onchange = function(){
        funcionarioAtual = this.value;
        if(funcionarioAtual){
            document.getElementById('dashboardRepositor').style.display='block';
            carregarDashboardRepositor();
            if(intervalAtualizacao) clearInterval(intervalAtualizacao);
            intervalAtualizacao = setInterval(carregarDashboardRepositor, 2500);
        } else {
            document.getElementById('dashboardRepositor').style.display='none';
            if(intervalAtualizacao) clearInterval(intervalAtualizacao);
        }
    }
}

function sair(){ 
    if(confirm('Deseja realmente sair do sistema?')) {
        if(intervalAtualizacao) clearInterval(intervalAtualizacao);
        location.reload(); 
    }
}

/* ========================= DASHBOARD GESTOR ========================= */

function carregarDashboardGestor(){
    // Recarrega todos os dados
    carregarDadosGlobais();
    
    const hoje = new Date().toISOString().split('T')[0];
    
    const reposHoje = reposicoes.filter(r=>r.data===hoje);
    const perdasHoje = perdas.filter(p=>p.data===hoje);

    document.getElementById('totalReposicoes').textContent = reposHoje.length;
    document.getElementById('totalPerdas').textContent = perdasHoje.length;

    const alertas = [...new Set(faltasGondola.filter(f=>!f.resolvido).map(f=>f.setor))].length;
    document.getElementById('setoresAlerta').textContent = alertas;
    
    // (ATUALIZADO) Total de setores √© din√¢mico
    document.getElementById('totalSetores').textContent = setores.length;

    // Estat√≠sticas de perdas
    document.getElementById('totalPerdasGeral').textContent = perdas.length;
    document.getElementById('totalVencidos').textContent = perdas.filter(p=>p.tipo==='vencido').length;
    document.getElementById('totalAvariados').textContent = perdas.filter(p=>p.tipo==='avariado').length;
    document.getElementById('totalQuebras').textContent = perdas.filter(p=>p.tipo==='quebra').length;

    // Popula filtro de setores (DIN√ÇMICO)
    const filtroSetor = document.getElementById('filtroSetor'); 
    const valorAtual = filtroSetor.value; // Salva o filtro atual
    filtroSetor.innerHTML = '<option value="">Todos os Setores</option>';
    setores.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(s=> {
        filtroSetor.innerHTML += `<option value="${s.nome}">${s.nome}</option>`;
    });
    filtroSetor.value = valorAtual; // Restaura o filtro

    // Atualiza se√ß√µes
    atualizarMapaSetores();
    atualizarListaReposicoes();
    atualizarListaPerdasDetalhada();
    atualizarRelatorioRepositor();
    atualizarListaInformativos();
    atualizarListaHistorico(); 
}

/*
   AtualizarMapaSetores: (ATUALIZADO - DIN√ÇMICO)
*/
function atualizarMapaSetores(){
    const mapa = document.getElementById('mapaSetores'); 
    mapa.innerHTML = '';
    
    if (setores.length === 0) {
        mapa.innerHTML = '<div style="padding:14px;color:#6b7d8a;text-align:center">Nenhum setor cadastrado.</div>';
        return;
    }
    
    setores.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(setor=>{
        const falta = faltasGondola.find(f=>f.setor===setor.nome && !f.resolvido);
        const ultimaRepos = reposicoes.filter(r=>r.setor===setor.nome).pop();
        const div = document.createElement('div');
        div.className = 'setor-item '+(falta? 'setor-falta':'setor-ok');
        
        // Encontra o nome do respons√°vel (ou usa o nome salvo se n√£o encontrar)
        const responsavel = funcionarios.find(f => f.nome.toUpperCase() === setor.responsavel_nome.toUpperCase());
        const nomeResponsavel = responsavel ? responsavel.nome : (setor.responsavel_nome || 'N/A');
        
        div.innerHTML = `
            <div>
                <div style="font-weight:700">${setor.nome}</div>
                <div style="font-size:13px;color:#5b6b77">${nomeResponsavel}</div>
                ${ultimaRepos?`<div style="font-size:12px;color:#8fa6b9">√ölt: ${ultimaRepos.data} ${ultimaRepos.hora}</div>`:''}
                ${falta?`<div style="color:#dc3545;font-weight:700;margin-top:4px">üö® ${falta.produto}</div>`:''}
            </div>
            <div><span class="badge" style="background:${falta?'#dc3545':'#28a745'};color:#fff">${falta? 'FALTA':'OK'}</span></div>
        `;
        div.onclick = ()=> mostrarDetalhesSetor(setor.nome);
        mapa.appendChild(div);
    });
}

function mostrarDetalhesSetor(nomeSetor){
    // ... (Esta fun√ß√£o n√£o precisa de mudan√ßas, pois j√° filtra por 'nomeSetor')
    // ... (C√≥digo omitido por brevidade, √© o mesmo da v2.1)
    
    const repoSet = reposicoes.filter(r=>r.setor===nomeSetor);
    const perdasSet = perdas.filter(p=>p.setor===nomeSetor);
    const faltasSet = faltasGondola.filter(f=>f.setor===nomeSetor);
    
    let html = `
        <div style="margin-bottom:18px;padding:12px;background:#f8fbff;border-radius:8px">
            <strong>üìä Estat√≠sticas do Setor</strong>
            <div style="margin-top:8px;display:flex;gap:16px;flex-wrap:wrap">
                <div>‚úÖ Reposi√ß√µes: <strong>${repoSet.length}</strong></div>
                <div>‚ö†Ô∏è Perdas: <strong>${perdasSet.length}</strong></div>
                <div>üö® Alertas: <strong>${faltasSet.length}</strong></div>
            </div>
        </div>
    `;

    // √öltimas reposi√ß√µes
    html += '<h4 style="margin-top:16px;color:#163d67">üì¶ √öltimas Reposi√ß√µes</h4>';
    if(repoSet.length === 0){
        html += '<div style="padding:12px;color:#6b7d8a">Nenhuma reposi√ß√£o registrada</div>';
    } else {
        repoSet.slice(-10).reverse().forEach(r=>{
            html += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px">
                <div style="font-weight:700">üì¶ ${r.produto} <span style="color:#2F80ED">(${r.quantidade})</span></div>
                <div style="font-size:13px;color:#5b6b77;margin-top:4px">
                    üë§ ${r.responsavel} ‚Ä¢ üìÖ ${r.data} ‚è∞ ${r.hora}
                </div>
                ${r.codBarras ? `<div style="font-size:12px;color:#8fa6b9">üìä C√≥d. Barras: ${r.codBarras}</div>` : ''}
                ${r.codProduto ? `<div style="font-size:12px;color:#8fa6b9">üè∑Ô∏è C√≥d. Produto: ${r.codProduto}</div>` : ''}
            </div>`;
        });
    }
    
    // Alertas de Falta
    if(faltasSet.length > 0){
        html += '<h4 style="margin-top:16px;color:#ffc107">üö® Alertas de Falta</h4>';
        faltasSet.slice().reverse().forEach(f=>{
            html += `<div style="padding:12px;border-radius:8px;background:#fffbea;margin-bottom:8px">
                <div style="font-weight:700">üö® ${f.produto}</div>
                <div style="font-size:13px;color:#5b6b77;margin-top:4px">
                    üë§ Reportado por ${f.responsavel} ‚Ä¢ üìÖ ${f.data} ‚è∞ ${f.hora}
                </div>
                <div style="margin-top:8px">
                    Status: ${f.resolvido?'<strong style="color:#28a745">‚úÖ RESOLVIDO</strong>':'<strong style="color:#dc3545">‚è≥ PENDENTE</strong>'}
                </div>
                ${f.resolvido ? `
                    <div style="margin-top:8px;padding:8px;background:#d4edda;border-radius:6px">
                        <div style="font-size:12px;font-weight:700;color:#28a745">üí¨ FEEDBACK:</div>
                        <div style="font-size:13px;margin-top:4px">${f.feedback||'Sem feedback'}</div>
                    </div>
                ` : `
                    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick='resolverFalta(${f.id})'>‚úÖ Marcar como Resolvido</button>
                        <button class="btn btn-secondary" onclick='removerFalta(${f.id})'>üóëÔ∏è Remover Alerta</button>
                    </div>
                `}
            </div>`;
        });
    }

    document.getElementById('tituloDetalhesSetor').textContent = 'üè™ ' + nomeSetor;
    document.getElementById('conteudoDetalhesSetor').innerHTML = html;
    document.getElementById('modalDetalhesSetor').style.display = 'block';
}


function resolverFalta(id){
    const msg = prompt('üí¨ Digite um feedback para o repositor:\n(ex: "Produto reabastecido", "Verificar com fornecedor")');
    if(msg === null) return;
    
    carregarDadosGlobais();
    const idx = faltasGondola.findIndex(f=>f.id===id);
    if(idx>=0){
        faltasGondola[idx].resolvido = true;
        faltasGondola[idx].resolvidoPor = funcionarioAtual;
        faltasGondola[idx].resolvidoEm = new Date().toISOString();
        faltasGondola[idx].feedback = sanitize(msg.trim()) || 'Resolvido sem observa√ß√µes';
        localStorage.setItem(K.FALTAS, JSON.stringify(faltasGondola));
        mostrarNotificacao('‚úÖ Falta marcada como resolvida!');
        mostrarDetalhesSetor(faltasGondola[idx].setor);
        carregarDashboardGestor();
    }
}

function removerFalta(id){
    if(!confirm('Confirma remo√ß√£o deste alerta?')) return;
    
    carregarDadosGlobais();
    const setor = faltasGondola.find(f=>f.id===id)?.setor;
    faltasGondola = faltasGondola.filter(f=>f.id!==id);
    localStorage.setItem(K.FALTAS, JSON.stringify(faltasGondola));
    mostrarNotificacao('üóëÔ∏è Alerta removido.');
    
    if(setor) mostrarDetalhesSetor(setor);
    else fecharModal('modalDetalhesSetor');
    
    carregarDashboardGestor();
}

// Fun√ß√µes de lista (sem altera√ß√£o, omitidas por brevidade)
function atualizarListaReposicoes(){ /* ...c√≥digo v2.1... */ }
function atualizarListaPerdasDetalhada(){ /* ...c√≥digo v2.1... */ }
function atualizarRelatorioRepositor(){ /* ...c√≥digo v2.1... */ }
function atualizarListaInformativos(){ /* ...c√≥digo v2.1... */ }

// (Fun√ß√µes de lista coladas para garantir funcionalidade)
function atualizarListaReposicoes(){
    const lista = document.getElementById('listaReposicoes'); 
    lista.innerHTML='';
    const ultimas = reposicoes.slice(-10).reverse();
    if(!ultimas.length){ lista.innerHTML = '<div style="padding:14px;color:#6b7d8a;text-align:center">Nenhuma reposi√ß√£o recente</div>'; return; }
    ultimas.forEach(r=>{
        lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px">
            <div style="font-weight:700">üì¶ ${r.produto} <span style="color:#2F80ED">(${r.quantidade})</span></div>
            <div style="font-size:13px;color:#5b6b77;margin-top:4px">üè™ ${r.setor} ‚Ä¢ üë§ ${r.responsavel}</div>
            <div style="font-size:12px;color:#8fa6b9;margin-top:2px">üìÖ ${r.data} ‚è∞ ${r.hora}</div>
        </div>`;
    });
}
function atualizarListaPerdasDetalhada(){
    const lista = document.getElementById('listaPerdasDetalhada'); 
    lista.innerHTML='';
    const ultimas = perdas.slice(-10).reverse();
    if(!ultimas.length){ lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Sem perdas registradas</div>'; return; }
    ultimas.forEach(p=>{
        lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fff5f5;margin-bottom:8px">
            <div style="font-weight:700">‚ö†Ô∏è ${p.produto} <span style="color:#dc3545">(${p.quantidade})</span></div>
            <div style="font-size:13px;color:#5b6b77;margin-top:4px">üìã ${p.tipo.toUpperCase()} ‚Ä¢ üè™ ${p.setor} ‚Ä¢ üë§ ${p.responsavel}</div>
            <div style="font-size:12px;color:#8fa6b9;margin-top:2px">üìÖ ${p.data} ‚è∞ ${p.hora}</div>
            <div style="font-size:13px;color:#6b7d8a;margin-top:4px">üí¨ ${p.motivo}</div>
        </div>`;
    });
}
function atualizarRelatorioRepositor(){
    const rel = document.getElementById('relatorioRepositor'); 
    rel.innerHTML='';
    const dados = {};
    reposicoes.forEach(r=>{ dados[r.responsavel] = (dados[r.responsavel]||0)+1; });
    if(Object.keys(dados).length===0){ rel.innerHTML='<div style="padding:12px;color:#6b7d8a;text-align:center">Sem dados</div>'; return; }
    Object.entries(dados).sort((a,b)=>b[1]-a[1]).forEach(([nome,total])=>{
        rel.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px;display:flex;justify-content:space-between">
            <div><strong>üë§ ${nome}</strong></div>
            <div><span style="color:#2F80ED;font-weight:700">${total}</span> reposi√ß√µes</div>
        </div>`;
    });
}
function atualizarListaInformativos(){
    const lista = document.getElementById('listaInformativos'); 
    lista.innerHTML='';
    if(!informativos.length){ lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum informativo</div>'; return; }
    informativos.slice(-10).reverse().forEach(info=>{
        lista.innerHTML += `<div class="informativo-item">
            <div style="font-weight:700">üì¢ ${info.titulo}</div>
            <div style="margin-top:6px;line-height:1.5">${info.mensagem}</div>
            <div style="font-size:12px;color:#6b7d8a;margin-top:8px">üìÖ ${info.data} ‚è∞ ${info.hora}</div>
        </div>`;
    });
}

function atualizarListaHistorico(){
    const lista = document.getElementById('listaHistoricoServicos'); 
    lista.innerHTML='';
    if(!historicoServicos.length){ 
        lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhuma ocorr√™ncia registrada</div>'; 
        return; 
    }
    
    const icones = {
        executado: '‚úÖ',
        nao_executado: '‚ö†Ô∏è',
        observacao: '‚ÑπÔ∏è'
    };
    
    // Mostra os √∫ltimos 20 registros
    historicoServicos.slice(-20).reverse().forEach(h => {
        const icone = icones[h.tipo] || '‚úçÔ∏è';
        const classe = h.tipo || 'observacao';
        
        lista.innerHTML += `
            <div class="historico-item ${classe}">
                <div style="font-weight:700">${icone} ${h.tipo.replace('_', ' ').toUpperCase()}</div>
                <div style="margin-top:6px;line-height:1.5;color:#213547">${h.descricao}</div>
                <div style="font-size:12px;color:#6b7d8a;margin-top:8px">
                    üë§ Registrado por: <strong>${h.autor}</strong> ‚Ä¢ üìÖ ${h.data} ‚è∞ ${h.hora}
                </div>
            </div>
        `;
    });
}

/* ========================= DASHBOARD REPOSITOR ========================= */

function carregarDashboardRepositor(){
    // Carrega dados globais
    carregarDadosGlobais();

    // Identifica setor (AGORA DIN√ÇMICO)
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    
    if(!setor) {
        document.getElementById('meuSetor').textContent = 'N√ÉO ASSOCIADO';
        console.error('Repositor sem setor definido:', funcionarioAtual);
    } else {
        document.getElementById('meuSetor').textContent = setor.nome;
    }
    
    const hoje = new Date().toISOString().split('T')[0];
    
    // Estat√≠sticas do dia
    const minhasRep = reposicoes.filter(r=>r.responsavel===funcionarioAtual && r.data===hoje);
    const minhasPerd = perdas.filter(p=>p.responsavel===funcionarioAtual && p.data===hoje);
    const minhasFaltas = faltasGondola.filter(f=>f.responsavel===funcionarioAtual && !f.resolvido);
    
    document.getElementById('minhasReposicoesHoje').textContent = minhasRep.length;
    document.getElementById('minhasPerdasHoje').textContent = minhasPerd.length;
    document.getElementById('minhasFaltasAbertas').textContent = minhasFaltas.length;

    // Lista de registros do dia
    const lista = document.getElementById('minhasReposicoes'); 
    lista.innerHTML='';
    const todos = [
        ...minhasRep.map(r=>({...r,'_tipo':'rep'})), 
        ...minhasPerd.map(p=>({...p,'_tipo':'perd'}))
    ].sort((a,b)=>b.timestamp-a.timestamp);
    
    if(!todos.length) {
        lista.innerHTML='<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum registro hoje</div>';
    } else {
        todos.forEach(r=>{
            if(r._tipo==='rep'){
                lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px">
                    <div style="font-weight:700">‚úÖ ${r.produto} <span style="color:#2F80ED">(${r.quantidade})</span></div>
                    <div style="font-size:13px;color:#5b6b77">‚è∞ ${r.hora}</div>
                </div>`;
            } else {
                lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fff5f5;margin-bottom:8px">
                    <div style="font-weight:700">‚ö†Ô∏è ${r.produto} <span style="color:#dc3545">(${r.quantidade})</span></div>
                    <div style="font-size:13px;color:#5b6b77">‚è∞ ${r.hora}</div>
                    <div style="font-size:13px;color:#6b7d8a">üìã Tipo: ${r.tipo}</div>
                </div>`;
            }
        });
    }
    
    // Atualiza feedbacks e informativos
    atualizarFeedbacksFaltas();
    atualizarInformativosRepositor();
    atualizarMinhaEscala(); // NOVO
}

function atualizarFeedbacksFaltas(){ /* ...c√≥digo v2.1... */ }
function atualizarInformativosRepositor(){ /* ...c√≥digo v2.1... */ }

// (Fun√ß√µes de feedback/informativos coladas para garantir funcionalidade)
function atualizarFeedbacksFaltas(){
    const minhasFaltas = faltasGondola.filter(f=>f.responsavel===funcionarioAtual);
    const lista = document.getElementById('minhasFaltasComFeedback');
    lista.innerHTML = '';
    if(!minhasFaltas.length){
        lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum alerta de falta reportado</div>';
        return;
    }
    minhasFaltas.sort((a,b)=>{
        if(a.resolvido === b.resolvido) return b.timestamp - a.timestamp;
        return a.resolvido ? 1 : -1;
    });
    minhasFaltas.forEach(f=>{
        const statusIcon = f.resolvido ? '‚úÖ' : '‚è≥';
        const statusText = f.resolvido ? 'RESOLVIDO' : 'AGUARDANDO AN√ÅLISE';
        lista.innerHTML += `<div style="padding:12px;border-radius:8px;background:${f.resolvido?'#d4edda':'#fff3cd'};margin-bottom:10px;border-left:4px solid ${f.resolvido?'#28a745':'#ffc107'}">
            <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px">
                <div style="flex:1">
                    <div style="font-weight:700;color:#213547">üö® ${f.produto}</div>
                    <div style="font-size:13px;color:#5b6b77;margin-top:4px">üìÖ ${f.data} ‚è∞ ${f.hora} | üè™ ${f.setor}</div>
                </div>
                <div><span style="padding:4px 12px;background:${f.resolvido?'#28a745':'#ffc107'};color:#fff;border-radius:12px;font-size:12px;font-weight:700">${statusIcon} ${statusText}</span></div>
            </div>
            ${f.resolvido ? `
                <div style="margin-top:10px;padding:10px;background:#fff;border-radius:6px">
                    <div style="font-size:12px;font-weight:700;color:#28a745;margin-bottom:4px">üí¨ FEEDBACK DO GESTOR:</div>
                    <div style="font-size:13px;color:#213547">${f.feedback || 'Sem observa√ß√µes'}</div>
                </div>
            ` : `
                <div style="margin-top:8px;font-size:12px;color:#856404">‚è≥ Aguardando an√°lise e feedback...</div>
            `}
        </div>`;
    });
}
function atualizarInformativosRepositor(){
    carregarDadosGlobais(); // Garante que informativos est√£o carregados
    const listaInfo = document.getElementById('informativosRepositor'); 
    listaInfo.innerHTML='';
    if(!informativos.length){ listaInfo.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum informativo</div>'; return; }
    informativos.slice(-10).reverse().forEach(info=>{
        listaInfo.innerHTML += `<div class="informativo-item">
            <div style="font-weight:700">üì¢ ${info.titulo}</div>
            <div style="margin-top:6px;line-height:1.5">${info.mensagem}</div>
            <div style="font-size:12px;color:#6b7d8a;margin-top:8px">üìÖ ${info.data} ‚è∞ ${info.hora}</div>
        </div>`;
    });
}

// NOVO: Atualiza a escala do repositor
function atualizarMinhaEscala() {
    const div = document.getElementById('minhaEscala');
    div.innerHTML = '';
    carregarDadosGlobais(); // Garante que escalas est√£o carregadas
    
    const minhaEscala = escalas[funcionarioAtual];
    
    if (!minhaEscala) {
        div.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhuma escala definida.</div>';
        return;
    }
    
    let html = `
        <table class="escala-table">
            <tr>
                <th>Dia</th>
                <th>Hor√°rio</th>
            </tr>
            <tr>
                <th>Dom</th>
                <td class="${minhaEscala.dom?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.dom || 'N/A')}</td>
            </tr>
            <tr>
                <th>Seg</th>
                <td class="${minhaEscala.seg?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.seg || 'N/A')}</td>
            </tr>
            <tr>
                <th>Ter</th>
                <td class="${minhaEscala.ter?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.ter || 'N/A')}</td>
            </tr>
            <tr>
                <th>Qua</th>
                <td class="${minhaEscala.qua?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.qua || 'N/A')}</td>
            </tr>
            <tr>
                <th>Qui</th>
                <td class="${minhaEscala.qui?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.qui || 'N/A')}</td>
            </tr>
            <tr>
                <th>Sex</th>
                <td class="${minhaEscala.sex?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.sex || 'N/A')}</td>
            </tr>
            <tr>
                <th>S√°b</th>
                <td class="${minhaEscala.sab?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.sab || 'N/A')}</td>
            </tr>
        </table>
    `;
    div.innerHTML = html;
}

/* ========================= A√á√ïES: MODAIS E SALVAMENTO ========================= */

function abrirModalReposicao(){ /* ...c√≥digo v2.1... */ }
function abrirModalPerda(){ /* ...c√≥digo v2.1... */ }
function abrirModalInformativo(){ /* ...c√≥digo v2.1... */ }
function fecharModal(id){ document.getElementById(id).style.display='none'; }
function alterarTipoBusca(){ /* ...c√≥digo v2.1... */ }

// (Fun√ß√µes de modais coladas para garantir funcionalidade)
function abrirModalReposicao(){ 
    document.getElementById('modalReposicao').style.display='block';
    document.getElementById('inputProduto').value = '';
    document.getElementById('inputQuantidade').value = '';
    document.getElementById('inputCodBarras').value = '';
    document.getElementById('inputCodProduto').value = '';
    document.getElementById('inputDataFabricacao').value = '';
    document.getElementById('inputDataValidade').value = '';
    document.getElementById('inputAvaria').value = 'nao';
    document.getElementById('inputObservacao').value = '';
    alterarTipoBusca();
}
function abrirModalPerda(){ 
    document.getElementById('modalPerda').style.display='block';
    document.getElementById('inputCodBarrasPerda').value = '';
    document.getElementById('inputProdutoPerda').value = '';
    document.getElementById('inputTipoPerda').value = 'vencido';
    document.getElementById('inputQuantidadePerda').value = '';
    document.getElementById('inputMotivoPerda').value = '';
}
function abrirModalInformativo(){ 
    document.getElementById('modalInformativo').style.display='block';
    document.getElementById('inputTituloInfo').value = '';
    document.getElementById('inputMensagemInfo').value = '';
}
function alterarTipoBusca(){
    const tipo = document.querySelector('input[name="buscaTipo"]:checked').value;
    const codBarras = document.getElementById('inputCodBarras');
    const codProduto = document.getElementById('inputCodProduto');
    if(tipo === 'codBarras'){
        codBarras.disabled = false; codBarras.required = true;
        codProduto.disabled = true; codProduto.required = false; codProduto.value = '';
        codBarras.focus();
    } else {
        codBarras.disabled = true; codBarras.required = false; codBarras.value = '';
        codProduto.disabled = false; codProduto.required = true;
        codProduto.focus();
    }
}


/*
   SalvarReposicao: (ATUALIZADO - DIN√ÇMICO)
*/
function salvarReposicao(){
    const produto = document.getElementById('inputProduto').value.trim();
    const quantidade = parseInt(document.getElementById('inputQuantidade').value);
    const codBarras = document.getElementById('inputCodBarras').value.trim();
    const codProduto = document.getElementById('inputCodProduto').value.trim();
    
    if(!produto || !quantidade || !codBarras && !codProduto){ 
        mostrarNotificacao('Preencha nome, quantidade e c√≥digo','error'); 
        return; 
    }

    // Busca setor dinamicamente
    carregarDadosGlobais();
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    const agora = new Date();
    
    const repos = {
        id: Date.now(),
        produto: sanitize(produto),
        quantidade,
        codBarras: sanitize(codBarras),
        codProduto: sanitize(codProduto),
        dataFabricacao: document.getElementById('inputDataFabricacao').value,
        dataValidade: document.getElementById('inputDataValidade').value,
        avaria: document.getElementById('inputAvaria').value,
        observacao: sanitize(document.getElementById('inputObservacao').value.trim()),
        setor: setor ? setor.nome : '‚Äî',
        responsavel: funcionarioAtual,
        data: agora.toISOString().split('T')[0],
        hora: agora.toLocaleTimeString('pt-BR'),
        timestamp: agora.getTime()
    };
    
    reposicoes.push(repos);
    localStorage.setItem(K.REPOSICOES, JSON.stringify(reposicoes));
    fecharModal('modalReposicao');
    mostrarNotificacao('‚úÖ Reposi√ß√£o registrada com sucesso!');
    carregarDashboardRepositor();
}

/*
   SalvarPerda: (ATUALIZADO - DIN√ÇMICO)
*/
function salvarPerda(){
    const produto = document.getElementById('inputProdutoPerda').value.trim();
    const quantidade = parseInt(document.getElementById('inputQuantidadePerda').value);
    const motivo = document.getElementById('inputMotivoPerda').value.trim();
    
    if(!produto || !quantidade || !motivo){ 
        mostrarNotificacao('Preencha todos os campos obrigat√≥rios','error'); 
        return; 
    }
    
    carregarDadosGlobais();
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    const agora = new Date();
    
    const p = { 
        id: Date.now(), 
        produto: sanitize(produto), 
        tipo: document.getElementById('inputTipoPerda').value, 
        quantidade, 
        motivo: sanitize(motivo), 
        codBarras: sanitize(document.getElementById('inputCodBarrasPerda').value.trim()), 
        setor: setor ? setor.nome : '‚Äî', 
        responsavel: funcionarioAtual, 
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        timestamp: agora.getTime() 
    };
    
    perdas.push(p); 
    localStorage.setItem(K.PERDAS, JSON.stringify(perdas)); 
    fecharModal('modalPerda'); 
    mostrarNotificacao('‚úÖ Perda registrada com sucesso!'); 
    carregarDashboardRepositor();
}

/*
   RegistrarFalta: (ATUALIZADO - DIN√ÇMICO)
*/
function registrarFalta(){
    const produto = prompt('üö® Digite o nome do produto que est√° em falta:'); 
    if(!produto || !produto.trim()) return;
    
    carregarDadosGlobais();
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    const agora = new Date();
    
    const f = { 
        id: Date.now(), 
        produto: sanitize(produto.trim()), 
        setor: setor ? setor.nome : '‚Äî', 
        responsavel: funcionarioAtual, 
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        resolvido: false, 
        timestamp: agora.getTime() 
    };
    
    faltasGondola.push(f); 
    localStorage.setItem(K.FALTAS, JSON.stringify(faltasGondola)); 
    mostrarNotificacao('üö® Falta registrada! O gestor ser√° notificado.');
    carregarDashboardRepositor();
}

function enviarInformativo(){
    const titulo = document.getElementById('inputTituloInfo').value.trim();
    const mensagem = document.getElementById('inputMensagemInfo').value.trim();
    
    if(!titulo || !mensagem){ 
        mostrarNotificacao('Preencha t√≠tulo e mensagem','error'); 
        return; 
    }
    
    const agora = new Date();
    informativos.push({ 
        id: Date.now(), 
        titulo: sanitize(titulo), 
        mensagem: sanitize(mensagem), 
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        timestamp: agora.getTime() 
    });
    
    localStorage.setItem(K.INFORMATIVOS, JSON.stringify(informativos));
    fecharModal('modalInformativo'); 
    mostrarNotificacao('üì¢ Informativo enviado com sucesso!');
    carregarDashboardGestor();
}

function abrirModalHistorico(){
    document.getElementById('modalHistorico').style.display='block';
    document.getElementById('inputHistoricoTipo').value = 'executado';
    document.getElementById('inputHistoricoDescricao').value = '';
    document.getElementById('inputHistoricoDescricao').focus();
}

function salvarHistoricoServico(){
    const tipo = document.getElementById('inputHistoricoTipo').value;
    const descricao = document.getElementById('inputHistoricoDescricao').value.trim();
    
    if(!descricao){ 
        mostrarNotificacao('Preencha a descri√ß√£o da ocorr√™ncia','error'); 
        return; 
    }
    
    carregarDadosGlobais(); // Garante que funcionarioAtual est√° correto
    const agora = new Date();
    
    const novoRegistro = { 
        id: Date.now(), 
        tipo: tipo,
        descricao: sanitize(descricao), 
        autor: funcionarioAtual, // Salva quem registrou
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        timestamp: agora.getTime() 
    };
    
    historicoServicos.push(novoRegistro);
    localStorage.setItem(K.HISTORICO_SERVICOS, JSON.stringify(historicoServicos));
    
    fecharModal('modalHistorico'); 
    mostrarNotificacao('‚úÖ Registro de hist√≥rico salvo!');
    carregarDashboardGestor(); // Atualiza a lista
}


/*
    ======================================================================
    NOVAS FUN√á√ïES (v3.0): GERENCIAMENTO (Funcion√°rios, Setores, Acessos)
    ======================================================================
*/

// Limpa formul√°rios de edi√ß√£o
function limparFormulario(tipo) {
    if (tipo === 'funcionario') {
        document.getElementById('formTituloFuncionario').textContent = '‚ûï Adicionar Novo Funcion√°rio';
        document.getElementById('inputFuncionarioId').value = '';
        document.getElementById('inputFuncionarioNome').value = '';
        document.getElementById('inputFuncionarioCargo').value = '';
        document.getElementById('btnLimparFuncionario').style.display = 'none';
        document.getElementById('inputFuncionarioNome').disabled = false;
    } else if (tipo === 'setor') {
        document.getElementById('formTituloSetor').textContent = '‚ûï Adicionar Novo Setor';
        document.getElementById('inputSetorId').value = '';
        document.getElementById('inputSetorNome').value = '';
        document.getElementById('inputSetorResponsavel').value = '';
        document.getElementById('btnLimparSetor').style.display = 'none';
    }
}

// ---- CONFIGURA√á√ïES ----
function abrirModalConfiguracoes() {
    fecharModal('modalFuncionarios');
    fecharModal('modalSetores');
    fecharModal('modalUsuarios');
    fecharModal('modalEscalas'); // NOVO
    document.getElementById('modalConfiguracoes').style.display = 'block';
}

// ---- FUNCION√ÅRIOS ----
function abrirModalFuncionarios() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalFuncionarios').style.display = 'block';
    limparFormulario('funcionario');
    carregarModalFuncionarios();
}

function carregarModalFuncionarios() {
    carregarDadosGlobais();
    const listaDiv = document.getElementById('listaFuncionarios');
    listaDiv.innerHTML = '';
    
    if (funcionarios.length === 0) {
        listaDiv.innerHTML = 'Nenhum funcion√°rio cadastrado.';
        return;
    }
    
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        const div = document.createElement('div');
        div.className = 'item-list-item';
        
        let userInfo = `<div><strong>üë§ ${f.nome}</strong><div style="font-size:13px;color:#6b7d8a">${f.cargo}</div></div>`;
        
        let actions = `<div class="item-list-actions">
            <button class="btn btn-edit" onclick="editarFuncionario(${f.id})">‚úèÔ∏è Editar</button>
            <button class="btn btn-danger" onclick="removerFuncionario(${f.id})">üóëÔ∏è Remover</button>
        </div>`;
        
        // Prote√ß√£o: N√£o pode remover funcion√°rio ADMIN
        if (f.nome.toUpperCase() === 'ADMIN') {
             actions = `<div class="item-list-actions">
                <button class="btn btn-edit" onclick="editarFuncionario(${f.id})">‚úèÔ∏è Editar</button>
                <button class="btn btn-danger" disabled style="opacity:0.5">üóëÔ∏è Remover</button>
            </div>`;
        }
        
        div.innerHTML = userInfo + actions;
        listaDiv.appendChild(div);
    });
}

function salvarFuncionario() {
    carregarDadosGlobais();
    const id = document.getElementById('inputFuncionarioId').value;
    const nome = document.getElementById('inputFuncionarioNome').value.trim().toUpperCase();
    const cargo = document.getElementById('inputFuncionarioCargo').value.trim();
    
    if (!nome || !cargo) {
        mostrarNotificacao('Preencha nome e cargo', 'error');
        return;
    }
    
    if (id) { // Editando
        const index = funcionarios.findIndex(f => f.id == id);
        if (index > -1) {
            // Se mudou o nome, tem que atualizar o nome do respons√°vel nos setores
            const nomeAntigo = funcionarios[index].nome;
            if (nomeAntigo !== nome) {
                // Atualiza setores
                setores.forEach(s => {
                    if (s.responsavel_nome === nomeAntigo) {
                        s.responsavel_nome = nome;
                    }
                });
                localStorage.setItem(K.SETORES, JSON.stringify(setores));
                
                // Atualiza hash de usu√°rio (login)
                if (usuariosHash[nomeAntigo]) {
                    usuariosHash[nome] = usuariosHash[nomeAntigo];
                    delete usuariosHash[nomeAntigo];
                    localStorage.setItem(K.USUARIOS, JSON.stringify(usuariosHash));
                }
                
                // NOVO: Atualiza escalas
                if (escalas[nomeAntigo]) {
                    escalas[nome] = escalas[nomeAntigo];
                    delete escalas[nomeAntigo];
                    localStorage.setItem(K.ESCALAS, JSON.stringify(escalas));
                }
            }
            
            funcionarios[index].nome = nome;
            funcionarios[index].cargo = cargo;
            mostrarNotificacao('‚úÖ Funcion√°rio atualizado!');
        }
    } else { // Criando
        // Verifica se nome j√° existe
        if (funcionarios.some(f => f.nome.toUpperCase() === nome)) {
            mostrarNotificacao('J√° existe um funcion√°rio com este nome', 'error');
            return;
        }
        const novoFuncionario = {
            id: Date.now(),
            nome: nome,
            cargo: cargo
        };
        funcionarios.push(novoFuncionario);
        mostrarNotificacao('‚úÖ Funcion√°rio adicionado!');
    }
    
    localStorage.setItem(K.FUNCIONARIOS, JSON.stringify(funcionarios));
    limparFormulario('funcionario');
    carregarModalFuncionarios();
}

function editarFuncionario(id) {
    carregarDadosGlobais();
    const func = funcionarios.find(f => f.id === id);
    if (func) {
        document.getElementById('formTituloFuncionario').textContent = '‚úèÔ∏è Editando Funcion√°rio';
        document.getElementById('inputFuncionarioId').value = func.id;
        document.getElementById('inputFuncionarioNome').value = func.nome;
        document.getElementById('inputFuncionarioCargo').value = func.cargo;
        document.getElementById('btnLimparFuncionario').style.display = 'inline-block';
        
        // Prote√ß√£o: N√£o pode editar o nome do ADMIN
        if (func.nome.toUpperCase() === 'ADMIN') {
            document.getElementById('inputFuncionarioNome').disabled = true;
        } else {
            document.getElementById('inputFuncionarioNome').disabled = false;
        }
    }
}

function removerFuncionario(id) {
    carregarDadosGlobais();
    const func = funcionarios.find(f => f.id === id);
    if (!func) return;
    
    if (func.nome.toUpperCase() === 'ADMIN') {
        mostrarNotificacao('N√£o √© poss√≠vel remover o ADMIN', 'error');
        return;
    }
    
    if (confirm(`Deseja remover ${func.nome}? \n\nIsso tamb√©m remover√° seu acesso (login), responsabilidade de setores e escala.`)) {
        // 1. Remove de setores
        setores.forEach(s => {
            if (s.responsavel_nome.toUpperCase() === func.nome.toUpperCase()) {
                s.responsavel_nome = 'AGUARDANDO';
            }
        });
        localStorage.setItem(K.SETORES, JSON.stringify(setores));
        
        // 2. Remove de usu√°rios (login)
        if (usuariosHash[func.nome.toUpperCase()]) {
            delete usuariosHash[func.nome.toUpperCase()];
            localStorage.setItem(K.USUARIOS, JSON.stringify(usuariosHash));
        }
        
        // 3. NOVO: Remove de escalas
        if (escalas[func.nome.toUpperCase()]) {
            delete escalas[func.nome.toUpperCase()];
            localStorage.setItem(K.ESCALAS, JSON.stringify(escalas));
        }
        
        // 4. Remove de funcion√°rios
        funcionarios = funcionarios.filter(f => f.id !== id);
        localStorage.setItem(K.FUNCIONARIOS, JSON.stringify(funcionarios));
        
        mostrarNotificacao('üóëÔ∏è Funcion√°rio removido.');
        carregarModalFuncionarios();
    }
}


// ---- SETORES ----
function abrirModalSetores() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalSetores').style.display = 'block';
    limparFormulario('setor');
    carregarModalSetores();
    popularSelectResponsavel();
}

function popularSelectResponsavel() {
    carregarDadosGlobais();
    const select = document.getElementById('inputSetorResponsavel');
    select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>';
    
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        select.innerHTML += `<option value="${f.nome}">${f.nome} - (${f.cargo})</option>`;
    });
}

function carregarModalSetores() {
    carregarDadosGlobais();
    const listaDiv = document.getElementById('listaSetores');
    listaDiv.innerHTML = '';
    
    if (setores.length === 0) {
        listaDiv.innerHTML = 'Nenhum setor cadastrado.';
        return;
    }
    
    setores.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(s => {
        const div = document.createElement('div');
        div.className = 'item-list-item';
        
        let setorInfo = `<div><strong>üè™ ${s.nome}</strong><div style="font-size:13px;color:#6b7d8a">Respons√°vel: ${s.responsavel_nome}</div></div>`;
        let actions = `<div class="item-list-actions">
            <button class="btn btn-edit" onclick="editarSetor(${s.id})">‚úèÔ∏è Editar</button>
            <button class="btn btn-danger" onclick="removerSetor(${s.id})">üóëÔ∏è Remover</button>
        </div>`;
        
        div.innerHTML = setorInfo + actions;
        listaDiv.appendChild(div);
    });
}

function salvarSetor() {
    carregarDadosGlobais();
    const id = document.getElementById('inputSetorId').value;
    const nome = document.getElementById('inputSetorNome').value.trim().toUpperCase();
    const responsavel = document.getElementById('inputSetorResponsavel').value;
    
    if (!nome || !responsavel) {
        mostrarNotificacao('Preencha nome e respons√°vel', 'error');
        return;
    }
    
    if (id) { // Editando
        const index = setores.findIndex(s => s.id == id);
        if (index > -1) {
            setores[index].nome = nome;
            setores[index].responsavel_nome = responsavel;
            mostrarNotificacao('‚úÖ Setor atualizado!');
        }
    } else { // Criando
        if (setores.some(s => s.nome.toUpperCase() === nome)) {
            mostrarNotificacao('J√° existe um setor com este nome', 'error');
            return;
        }
        const novoSetor = {
            id: Date.now(),
            nome: nome,
            responsavel_nome: responsavel
        };
        setores.push(novoSetor);
        mostrarNotificacao('‚úÖ Setor adicionado!');
    }
    
    localStorage.setItem(K.SETORES, JSON.stringify(setores));
    limparFormulario('setor');
    carregarModalSetores();
    carregarDashboardGestor(); // Atualiza mapa de setores
}

function editarSetor(id) {
    carregarDadosGlobais();
    const setor = setores.find(s => s.id === id);
    if (setor) {
        // Popula o select ANTES de setar o valor
        popularSelectResponsavel(); 
        
        document.getElementById('formTituloSetor').textContent = '‚úèÔ∏è Editando Setor';
        document.getElementById('inputSetorId').value = setor.id;
        document.getElementById('inputSetorNome').value = setor.nome;
        document.getElementById('inputSetorResponsavel').value = setor.responsavel_nome;
        document.getElementById('btnLimparSetor').style.display = 'inline-block';
    }
}

function removerSetor(id) {
    carregarDadosGlobais();
    const setor = setores.find(s => s.id === id);
    if (!setor) return;
    
    if (confirm(`Deseja remover o setor ${setor.nome}?`)) {
        setores = setores.filter(s => s.id !== id);
        localStorage.setItem(K.SETORES, JSON.stringify(setores));
        
        mostrarNotificacao('üóëÔ∏è Setor removido.');
        carregarModalSetores();
        carregarDashboardGestor(); // Atualiza mapa de setores
    }
}


// ---- ACESSOS (USU√ÅRIOS) ----
function abrirModalUsuarios() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalUsuarios').style.display = 'block';
    carregarModalUsuarios();
    popularSelectUsuarios();
}

function popularSelectUsuarios() {
    carregarDadosGlobais();
    const select = document.getElementById('inputUsuarioNovoNome');
    select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>';
    
    // Filtra funcion√°rios que AINDA N√ÉO t√™m login
    const funcionariosSemAcesso = funcionarios.filter(f => !usuariosHash[f.nome.toUpperCase()]);
    
    funcionariosSemAcesso.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        select.innerHTML += `<option value="${f.nome}">${f.nome} - (${f.cargo})</option>`;
    });
}

function carregarModalUsuarios() {
    carregarDadosGlobais();
    const listaDiv = document.getElementById('listaUsuariosAtual');
    listaDiv.innerHTML = '';
    
    const usuarios = Object.keys(usuariosHash).sort();
    
    if (usuarios.length === 0) {
        listaDiv.innerHTML = 'Nenhum usu√°rio cadastrado.';
        return;
    }
    
    usuarios.forEach(user => {
        const div = document.createElement('div');
        div.className = 'item-list-item';
        
        let userInfo = `<strong>üë§ ${user}</strong>`;
        if (user === 'ADMIN') {
            userInfo += ' <span style="font-size:12px;color:#163d67;font-weight:700">(Gestor Principal)</span>';
        }
        
        let actions = '';
        if (user !== 'ADMIN') {
            actions = `<button class="btn btn-danger" onclick="removerUsuario('${user}')">üóëÔ∏è Remover Acesso</button>`;
        }
        
        div.innerHTML = `<div>${userInfo}</div><div class="item-list-actions">${actions}</div>`;
        listaDiv.appendChild(div);
    });
}

async function salvarNovoUsuario() {
    carregarDadosGlobais();
    const user = document.getElementById('inputUsuarioNovoNome').value.toUpperCase();
    const pass = document.getElementById('inputSenhaNova').value;
    
    if (!user || !pass) {
        mostrarNotificacao('Selecione um funcion√°rio e digite uma senha', 'error');
        return;
    }
    if (pass.length < 6) {
        mostrarNotificacao('A senha deve ter no m√≠nimo 6 caracteres', 'error');
        return;
    }
    if (usuariosHash[user]) {
        mostrarNotificacao('Este funcion√°rio j√° possui um acesso', 'error');
        return;
    }
    
    usuariosHash[user] = await hashString(pass);
    localStorage.setItem(K.USUARIOS, JSON.stringify(usuariosHash));
    
    mostrarNotificacao(`‚úÖ Acesso criado para ${user}!`);
    
    document.getElementById('inputUsuarioNovoNome').value = '';
    document.getElementById('inputSenhaNova').value = '';
    carregarModalUsuarios();
    popularSelectUsuarios();
    carregarSelectFuncionarios(); // Atualiza a lista da tela principal
}

function removerUsuario(user) {
    if (user === 'ADMIN') return;
    
    if (confirm(`Tem certeza que deseja remover o ACESSO (login) do usu√°rio ${user}? O funcion√°rio n√£o ser√° removido.`)) {
        carregarDadosGlobais();
        delete usuariosHash[user];
        localStorage.setItem(K.USUARIOS, JSON.stringify(usuariosHash));
        
        mostrarNotificacao(`üóëÔ∏è Acesso de ${user} removido.`);
        carregarModalUsuarios();
        popularSelectUsuarios();
        carregarSelectFuncionarios(); // Atualiza a lista da tela principal
    }
}

// ---- ESCALAS (NOVO) ----
function abrirModalEscalas() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalEscalas').style.display = 'block';
    document.getElementById('formEscala').style.display = 'none';
    
    carregarDadosGlobais();
    const select = document.getElementById('selectFuncionarioEscala');
    select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>';
    
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        select.innerHTML += `<option value="${f.nome}">${f.nome} - (${f.cargo})</option>`;
    });
}

function carregarEscalaFuncionario(nome) {
    const form = document.getElementById('formEscala');
    if (!nome) {
        form.style.display = 'none';
        return;
    }
    
    carregarDadosGlobais();
    const escala = escalas[nome] || {}; // Pega escala ou objeto vazio
    
    document.getElementById('inputEscalaDom').value = escala.dom || '';
    document.getElementById('inputEscalaSeg').value = escala.seg || '';
    document.getElementById('inputEscalaTer').value = escala.ter || '';
    document.getElementById('inputEscalaQua').value = escala.qua || '';
    document.getElementById('inputEscalaQui').value = escala.qui || '';
    document.getElementById('inputEscalaSex').value = escala.sex || '';
    document.getElementById('inputEscalaSab').value = escala.sab || '';
    
    form.style.display = 'block';
}

function salvarEscalaFuncionario() {
    const nome = document.getElementById('selectFuncionarioEscala').value;
    if (!nome) {
        mostrarNotificacao('Nenhum funcion√°rio selecionado', 'error');
        return;
    }
    
    carregarDadosGlobais();
    
    const novaEscala = {
        dom: sanitize(document.getElementById('inputEscalaDom').value.trim().toUpperCase()),
        seg: sanitize(document.getElementById('inputEscalaSeg').value.trim().toUpperCase()),
        ter: sanitize(document.getElementById('inputEscalaTer').value.trim().toUpperCase()),
        qua: sanitize(document.getElementById('inputEscalaQua').value.trim().toUpperCase()),
        qui: sanitize(document.getElementById('inputEscalaQui').value.trim().toUpperCase()),
        sex: sanitize(document.getElementById('inputEscalaSex').value.trim().toUpperCase()),
        sab: sanitize(document.getElementById('inputEscalaSab').value.trim().toUpperCase())
    };
    
    escalas[nome] = novaEscala;
    localStorage.setItem(K.ESCALAS, JSON.stringify(escalas));
    
    mostrarNotificacao(`‚úÖ Escala de ${nome} salva com sucesso!`);
    // N√£o fecha o modal, permitindo editar outros.
}


/* ========================= FILTROS E EXPORTA√á√ïES ========================= */

function aplicarFiltros(){ /* ...c√≥digo v2.1... */ }
function limparFiltros(){ /* ...c√≥digo v2.1... */ }
function gerarPDF(){ window.print(); }
function exportarBackupJSON(){ /* ...c√≥digo v2.1... */ }
function importarBackupJSON(){ /* ...c√≥digo v2.1... */ }
function exportarRelatorioCSV(){ /* ...c√≥digo v2.1... */ }

// (Fun√ß√µes de filtros/exporta√ß√£o coladas para garantir funcionalidade)
function aplicarFiltros(){
    const data = document.getElementById('filtroData').value;
    const setorFiltro = document.getElementById('filtroSetor').value;
    let reposFil = [...reposicoes]; let perdasFil = [...perdas];
    if(data){ 
        reposFil = reposFil.filter(r=>r.data===data); 
        perdasFil = perdasFil.filter(p=>p.data===data); 
    }
    if(setorFiltro){ 
        reposFil = reposFil.filter(r=>r.setor===setorFiltro); 
        perdasFil = perdasFil.filter(p=>p.setor===setorFiltro); 
    }
    // ... (O resto da l√≥gica de exibi√ß√£o √© igual)
    mostrarNotificacao('üîç Filtros aplicados!');
}
function limparFiltros(){
    document.getElementById('filtroData').value = '';
    document.getElementById('filtroSetor').value = '';
    carregarDashboardGestor();
    mostrarNotificacao('üîÑ Filtros removidos');
}
function exportarBackupJSON(){
    carregarDadosGlobais(); // Garante que todos os dados din√¢micos est√£o no backup
    const backup = {
        versao: '3.2',
        dataExportacao: new Date().toISOString(),
        funcionarios: funcionarios,
        setores: setores,
        usuariosHash: usuariosHash,
        reposicoes: reposicoes,
        perdas: perdas,
        faltasGondola: faltasGondola,
        informativos: informativos,
        historicoServicos: historicoServicos,
        escalas: escalas // NOVO
    };
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_alkinda_v3.2_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    mostrarNotificacao('üíæ Backup exportado com sucesso!');
}
function importarBackupJSON(){
    if(!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° SUBSTITUIR todos os dados (incluindo funcion√°rios, setores e usu√°rios)!\n\nDeseja continuar?')){
        return;
    }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e){
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event){
            try {
                const backup = JSON.parse(event.target.result);
                if(!backup.reposicoes || !backup.perdas || !backup.funcionarios){
                    throw new Error('Arquivo de backup inv√°lido ou incompat√≠vel');
                }
                
                // Restaura TUDO
                localStorage.setItem(K.FUNCIONARIOS, JSON.stringify(backup.funcionarios || []));
                localStorage.setItem(K.SETORES, JSON.stringify(backup.setores || []));
                localStorage.setItem(K.USUARIOS, JSON.stringify(backup.usuariosHash || {}));
                localStorage.setItem(K.REPOSICOES, JSON.stringify(backup.reposicoes || []));
                localStorage.setItem(K.PERDAS, JSON.stringify(backup.perdas || []));
                localStorage.setItem(K.FALTAS, JSON.stringify(backup.faltasGondola || []));
                localStorage.setItem(K.INFORMATIVOS, JSON.stringify(backup.informativos || []));
                localStorage.setItem(K.HISTORICO_SERVICOS, JSON.stringify(backup.historicoServicos || []));
                localStorage.setItem(K.ESCALAS, JSON.stringify(backup.escalas || {})); // NOVO
                
                mostrarNotificacao('‚úÖ Backup restaurado com sucesso!');
                setTimeout(()=> location.reload(), 1500);
                
            } catch(erro) {
                mostrarNotificacao('‚ùå Erro ao restaurar backup: ' + erro.message, 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
function exportarRelatorioCSV(){
    // ... (L√≥gica de exporta√ß√£o CSV v2.1)
    // ... (Esta fun√ß√£o n√£o precisa de mudan√ßas, pois j√° l√™ dos arrays globais)
    let lines = [];
    lines.push('TIPO;ID;DATA;HORA;SETOR;RESPONSAVEL;PRODUTO;QTD;COD_BARRAS;COD_PRODUTO;TIPO_EXTRA;MOTIVO_OBS;FEEDBACK;STATUS');
    reposicoes.forEach(r=>{ lines.push(`REPOSICAO;${r.id};${r.data};${r.hora};${r.setor};${r.responsavel};${r.produto};${r.quantidade};${r.codBarras||''};${r.codProduto||''};${r.avaria||''};"${(r.observacao||'').replace(/"/g,'""')}";;COMPLETO`); });
    perdas.forEach(p=>{ lines.push(`PERDA;${p.id};${p.data};${p.hora};${p.setor};${p.responsavel};${p.produto};${p.quantidade};${p.codBarras||''};;${p.tipo};"${(p.motivo||'').replace(/"/g,'""')}";;REGISTRADO`); });
    faltasGondola.forEach(f=>{ const status = f.resolvido ? 'RESOLVIDO' : 'PENDENTE'; const feedback = (f.feedback||'').replace(/"/g,'""'); lines.push(`FALTA;${f.id};${f.data};${f.hora};${f.setor};${f.responsavel};${f.produto};;;;;;"${feedback}";${status}`); });
    informativos.forEach(i=>{ const msg = (i.mensagem||'').replace(/"/g,'""').replace(/\n/g,' '); lines.push(`INFORMATIVO;${i.id};${i.data};${i.hora};;;;${i.titulo};;;;;;"${msg}";ENVIADO`); });
    historicoServicos.forEach(h=>{ const desc = (h.descricao||'').replace(/"/g,'""').replace(/\n/g,' '); lines.push(`HISTORICO;${h.id};${h.data};${h.hora};;${h.autor};;;;;${h.tipo};"${desc}";;REGISTRADO`); });

    const csv = '\uFEFF' + lines.join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); 
    const a = document.createElement('a'); a.href = url; a.download = `relatorio_alkinda_${new Date().toISOString().slice(0,10)}.csv`; 
    document.body.appendChild(a); a.click(); a.remove(); 
    URL.revokeObjectURL(url);
    mostrarNotificacao('üì• Relat√≥rio CSV exportado com sucesso!');
}


/* ========================= INICIALIZA√á√ÉO ========================= */

/*
   CarregarDadosGlobais: (NOVO) Carrega dados do localStorage para vars globais
*/
function carregarDadosGlobais() {
    reposicoes = JSON.parse(localStorage.getItem(K.REPOSICOES)||'[]');
    perdas = JSON.parse(localStorage.getItem(K.PERDAS)||'[]');
    faltasGondola = JSON.parse(localStorage.getItem(K.FALTAS)||'[]');
    informativos = JSON.parse(localStorage.getItem(K.INFORMATIVOS)||'[]');
    usuariosHash = JSON.parse(localStorage.getItem(K.USUARIOS)||'{}');
    funcionarios = JSON.parse(localStorage.getItem(K.FUNCIONARIOS)||'[]');
    setores = JSON.parse(localStorage.getItem(K.SETORES)||'[]');
    historicoServicos = JSON.parse(localStorage.getItem(K.HISTORICO_SERVICOS)||'[]');
    escalas = JSON.parse(localStorage.getItem(K.ESCALAS)||'{}'); // NOVO
}


/* GarantirDadosIniciais: (NOVO) Popula o sistema no primeiro uso
*/
async function garantirDadosIniciais() {
    carregarDadosGlobais(); // Carrega o que existir
    
    let dadosSalvos = false;

    // 1. Garante Funcion√°rios
    if (funcionarios.length === 0) {
        localStorage.setItem(K.FUNCIONARIOS, JSON.stringify(DADOS_INICIAIS.funcionarios));
        dadosSalvos = true;
    }
    
    // 2. Garante Setores
    if (setores.length === 0) {
        localStorage.setItem(K.SETORES, JSON.stringify(DADOS_INICIAIS.setores));
        dadosSalvos = true;
    }

    // 3. Garante Usu√°rios (Logins)
    if (Object.keys(usuariosHash).length === 0) {
        console.log('üîß Inicializando usu√°rios pela primeira vez...');
        let novosUsuarios = {};
        
        // Cria gestor
        novosUsuarios['ADMIN'] = await hashString('gestor123');
        
        // Cria repositores padr√£o
        const repositores = ['PRICILA', 'JONATA', 'SAMUEL', 'SAMARA', 'HUGO', 'THIAGO', 'JOESON', 'VANDERSON', 'JOAO', 'MARCIO', 'SAMIRA', 'CARLINHOS'];
        for(const nome of repositores){
            novosUsuarios[nome] = await hashString('rep123');
        }
        
        localStorage.setItem(K.USUARIOS, JSON.stringify(novosUsuarios));
        dadosSalvos = true;
        console.log('‚úÖ Usu√°rios padr√£o criados!');
    }
    
    if (dadosSalvos) {
        console.log('‚úÖ Dados iniciais do sistema (funcion√°rios, setores, usu√°rios) foram criados.');
        // Recarrega os dados globais ap√≥s criar
        carregarDadosGlobais();
    }
}

// Inicializa√ß√£o ao carregar p√°gina
(async function init(){
    document.getElementById('logoImg').src = LOGO_PATH; 
    document.getElementById('headerLogo').src = LOGO_PATH;
    
    // Garante que dados existem
    await garantirDadosIniciais();
    
    // Carrega dados globais para uso imediato (ex: login)
    carregarDadosGlobais();
    
    const hoje = new Date().toISOString().split('T')[0]; 
    if(document.getElementById('filtroData')) {
        try { document.getElementById('filtroData').value = hoje; } catch (e) {}
    }
    
    console.log('%cüè™ Sistema Alkinda v3.2 - Gest√£o de Escalas', 'color: #2F80ED; font-size: 20px; font-weight: bold;');
    console.log('%c‚úÖ Sistema carregado! Setores e funcion√°rios agora s√£o din√¢micos.', 'color: #28a745; font-size: 14px;');
})();

/* Fecha modal clicando fora */
window.onclick = function(e){ 
    if(e.target.classList && e.target.classList.contains('modal')) {
        e.target.style.display = 'none'; 
    }
}
</script>
</body>
</html>
