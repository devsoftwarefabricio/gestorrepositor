<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema Alkinda - Gest√£o Completa (Nuvem)</title>
    <style>
        /* ========================= RESET E BASE ========================= */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #eef4ff 0%, #e9f7ff 100%);
            padding: 16px;
            color: #213547;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ========================= CARDS E CONTAINERS ========================= */
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,.08);
        }
        
        .login-wrap {
            max-width: 520px;
            margin: 36px auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .logo img {
            height: 78px;
            object-fit: contain;
        }

        /* ========================= TIPOGRAFIA ========================= */
        h1 {
            font-size: 20px;
            color: #0b3b66;
            margin-bottom: 12px;
        }
        
        .card-title {
            font-weight: 700;
            color: #163d67;
            margin-bottom: 10px;
        }

        /* ========================= BOT√ïES ========================= */
        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .btn {
            padding: 12px 14px;
            border-radius: 10px;
            border: 0;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-gestor {
            background: #163d67;
            color: #fff;
        }
        
        .btn-repositor {
            background: linear-gradient(90deg, #56CCF2, #2F80ED);
            color: #fff;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }
        
        .btn-primary {
            background: #2F80ED;
            color: #fff;
        }
        
        .btn-danger {
            background: #dc3545;
            color: #fff;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #213547;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 6px;
        }

        /* ========================= HEADER ========================= */
        .header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }
        
        .header-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .header-title {
            font-weight: 800;
            color: #163d67;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .select-funcionario {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #cfeefc;
        }
        
        .btn-sair {
            background: #ff6b6b;
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
        }

        /* ========================= GRID E CART√ïES ========================= */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 14px;
        }
        
        .stat {
            padding: 18px;
            border-radius: 10px;
            background: #fff;
        }
        
        .stat .value {
            font-size: 28px;
            font-weight: 800;
            color: #163d67;
        }

        /* ========================= MAPA DE SETORES ========================= */
        .setor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            border-left: 6px solid #56CCF2;
            background: #fbfeff;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .setor-item:hover {
            background: #f0f8ff;
            transform: translateX(4px);
        }
        
        .setor-falta {
            border-left-color: #dc3545;
            background: linear-gradient(180deg, #fff5f5, #fff8f8);
        }
        
        .setor-ok {
            border-left-color: #28a745;
        }
        
        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
        }

        /* ========================= MODAIS ========================= */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            z-index: 2000;
            overflow: auto;
            padding: 22px;
        }
        
        .modal .modal-inner {
            max-width: 720px;
            margin: 30px auto;
            background: #fff;
            padding: 18px;
            border-radius: 12px;
        }
        
        .form-group {
            margin: 10px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #435d73;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 9px;
            border-radius: 8px;
            border: 1px solid #e6eef8;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2F80ED;
        }
        
        /* Lista de Itens (Nova) */
        .item-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .item-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fbff;
            border-radius: 8px;
            margin-bottom: 6px;
        }
        .item-list-actions {
            display: flex;
            gap: 6px;
        }
        
        /* Modal Config (UX/UI) */
        .config-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }
        .config-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            border-radius: 12px;
            background: #f8fbff;
            border: 1px solid #eef5fb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .config-menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.05);
            border-color: #2F80ED;
        }
        .config-menu-item .icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        .config-menu-item .title {
            font-size: 16px;
            font-weight: 700;
            color: #163d67;
        }
        .config-menu-item .description {
            font-size: 13px;
            color: #6b7d8a;
            text-align: center;
            margin-top: 4px;
        }


        /* ========================= INFORMATIVOS ========================= */
        .informativo-item {
            background: linear-gradient(135deg, #fff3cd, #fff8d6);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        /* ========================= HIST√ìRICO DE OCORR√äNCIAS ========================= */
        .historico-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 6px solid #6c757d; /* Padr√£o/Observacao */
            background: #f8f9fa;
        }
        .historico-item.executado {
            border-left-color: #28a745; /* Verde */
            background: #f0fff3;
        }
        .historico-item.nao_executado {
            border-left-color: #dc3545; /* Vermelho */
            background: #fff5f5;
        }

        /* ========================= NOTIFICA√á√ïES ========================= */
        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #fff;
            padding: 10px 14px;
            border-left: 6px solid #28a745;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,.12);
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ========================= TABELAS / RELAT√ìRIO ========================= */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .table th, .table td {
            padding: 8px;
            border-bottom: 1px solid #eef5fb;
            text-align: left;
        }
        
        .table th {
            background: #f8fbff;
            font-weight: 700;
            color: #163d67;
        }
        
        /* Tabela de Escala */
        .escala-table { width: 100%; border-collapse: collapse; }
        .escala-table th, .escala-table td { 
            padding: 8px; 
            text-align: left; 
            border-bottom: 1px solid #eef5fb; 
        }
        .escala-table th { background: #f8fbff; color: #163d67; font-size: 13px; }
        .escala-table td { font-size: 14px; }
        .escala-table td.folga { font-weight: 700; color: #dc3545; background: #fff5f5; }

        /* ========================= FEEDBACK VISUAL ========================= */
        .feedback-resolvido {
            background: #d4edda;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #28a745;
        }
        
        .feedback-pendente {
            background: #fff3cd;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #ffc107;
        }

        
        /* ========================= RESPONSIVO - Mobile First ========================= */
        
        /* Bloco com corre√ß√µes de responsivo */
        @media(max-width:780px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .logo {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .logo img {
                height: 54px;
            }
            
            .login-wrap {
                margin: 18px auto; /* Centraliza o card */
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            
            .select-funcionario {
                width: 100%;
            }
            
            .btn-sair {
                width: 100%;
            }
        }
        
        @media(max-width:480px) {
            body {
                padding: 8px;
            }
            
            .card {
                padding: 12px;
            }
            
            .stat .value {
                font-size: 22px;
            }
            
            .modal-inner {
                padding: 12px;
            }
            
            .config-menu {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <script>const LOGO_PATH = './logo.jpeg';</script>
    
    <div id="loginBox" class="login-wrap card">
        <div class="logo">
            <img id="logoImg" src="" alt="Logo Alkinda" onerror="this.style.display='none'" />
            <div>
                <h1>AL KINDA ‚Äì Sistema de Gest√£o</h1>
                <div style="font-size:13px;color:#6b7d8a">Acesse como Gestor ou Repositor</div>
            </div>
        </div>

        <div style="margin-top:12px">
            <label style="font-weight:700">Selecione o tipo de acesso:</label>
            <div class="buttons">
                <button class="btn btn-gestor" onclick="abrirLogin('gestor')">üîí Gestor</button>
                <button class="btn btn-repositor" onclick="abrirLogin('repositor')">üì¶ Repositor</button>
            </div>
        </div>

        <div id="loginForm" style="margin-top:14px;display:none">
            <div class="form-group">
                <label>E-mail</label>
                <input id="loginEmail" type="email" placeholder="Digite seu e-mail de acesso" autocomplete="email">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input id="loginPass" type="password" placeholder="Digite sua senha" autocomplete="current-password">
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <button class="btn btn-gestor" onclick="fazerLogin()">Entrar</button>
                <button class="btn btn-secondary" onclick="fecharLogin()">Cancelar</button>
            </div>
            <div id="loginError" style="margin-top:12px;padding:10px;background:#fff5f5;border-radius:8px;font-size:12px;color:#dc3545;display:none;border-left:4px solid #dc3545;">
                Erro: E-mail ou senha incorretos.
            </div>
        </div>
    </div>

    <div id="mainScreen" style="display:none">
        <div class="header card">
            <div class="header-left">
                <img id="headerLogo" src="" style="height:46px;object-fit:contain" alt="Logo" />
                <div class="header-title" id="tituloSistema">Sistema de Gest√£o</div>
            </div>
            <div class="header-actions">
                <div id="selectFuncionarioDiv" style="display:none">
                    <select id="selectFuncionario" class="select-funcionario">
                        <option value="">Selecione seu nome</option>
                    </select>
                </div>
                <button class="btn-sair" onclick="sair()">üö™ Sair</button>
            </div>
        </div>

        <div id="dashboardGestor" style="display:none">
            <div class="grid" style="margin-bottom:12px">
                <div class="stat card">
                    <div class="card-title">Reposi√ß√µes Hoje</div>
                    <div class="value" id="totalReposicoes">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Perdas/Vencidos</div>
                    <div class="value" id="totalPerdas">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Setores em Alerta</div>
                    <div class="value" id="setoresAlerta">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Total de Setores</div>
                    <div class="value" id="totalSetores">0</div>
                </div>
            </div>

            <div class="card" style="margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                    <div><strong>üìä Filtros & A√ß√µes</strong></div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-gestor" onclick="abrirModalConfiguracoes()">‚öôÔ∏è Configura√ß√µes</button>
                        <button class="btn btn-repositor" onclick="exportarRelatorioCSV()">üì• CSV</button>
                        <button class="btn btn-primary" onclick="exportarBackupJSON()">üíæ Backup</button>
                        <button class="btn btn-secondary" onclick="importarBackupJSON()">üì§ Restaurar</button>
                        <button class="btn btn-primary" onclick="gerarPDF()">üìÑ PDF</button>
                        <button class="btn btn-gestor" onclick="abrirModalInformativo()">üì¢ Informativo</button>
                    </div>
                </div>
                <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                    <input type="date" id="filtroData" style="padding:8px;border-radius:8px;border:1px solid #e6eef8" />
                    <select id="filtroSetor" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
                        <option value="">Todos os Setores</option>
                    </select>
                    <button class="btn btn-primary" onclick="aplicarFiltros()">üîç Filtrar</button>
                    <button class="btn btn-secondary" onclick="limparFiltros()">üîÑ Limpar</button>
                </div>
            </div>

            <div class="card" style="margin-bottom:12px">
                <div class="card-title">‚ö†Ô∏è Central de Perdas e Vencidos</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
                    <div style="flex:1"><strong>Total:</strong> <span id="totalPerdasGeral">0</span></div>
                    <div style="flex:1"><strong>Vencidos:</strong> <span id="totalVencidos">0</span></div>
                    <div style="flex:1"><strong>Avariados:</strong> <span id="totalAvariados">0</span></div>
                    <div style="flex:1"><strong>Quebras:</strong> <span id="totalQuebras">0</span></div>
                </div>
                <div id="listaPerdasDetalhada"></div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-title">üó∫Ô∏è Mapa de Setores</div>
                    <div id="mapaSetores"></div>
                </div>
                <div class="card">
                    <div class="card-title">üì¶ Reposi√ß√µes</div>
                    <div id="listaReposicoes"></div>
                </div>
                <div class="card">
                    <div class="card-title">üë• Por Repositor</div>
                    <div id="relatorioRepositor"></div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
                    <div class="card-title">üì¢ Informativos Enviados</div>
                    <button class="btn btn-primary" onclick="abrirModalInformativo()">üì§ Enviar Novo</button>
                </div>
                <div id="listaInformativos"></div>
            </div>
            
            <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
                    <div class="card-title">üîÅ Hist√≥rico de Ocorr√™ncias (Handoff)</div>
                    <button class="btn btn-primary" onclick="abrirModalHistorico()">‚úçÔ∏è Registrar Novo</button>
                </div>
                <div id="listaHistoricoServicos"></div>
            </div>
            
        </div>

        <div id="dashboardRepositor" style="display:none">
            <div class="card">
                <div class="card-title">üè™ Meu Setor: <span id="meuSetor" style="color:#2F80ED"></span></div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-repositor" onclick="abrirModalReposicao()">‚úÖ Registrar Reposi√ß√£o</button>
                    <button class="btn btn-primary" onclick="abrirModalPerda()">‚ö†Ô∏è Registrar Perda/Vencido</button>
                    <button class="btn btn-gestor" onclick="registrarFalta()">üö® Produto em Falta</button>
                </div>
            </div>

            <div class="grid" style="margin-top:12px">
                <div class="stat card">
                    <div class="card-title">Reposi√ß√µes Hoje</div>
                    <div class="value" id="minhasReposicoesHoje">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Perdas Hoje</div>
                    <div class="value" id="minhasPerdasHoje">0</div>
                </div>
                <div class="stat card">
                    <div class="card-title">Faltas Reportadas</div>
                    <div class="value" id="minhasFaltasAbertas">0</div>
                </div>
            </div>
            
            <div class="card" style="margin-top:12px">
                <div class="card-title">üóìÔ∏è Minha Escala Semanal</div>
                <div id="minhaEscala"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">üìã Meus Registros Hoje</div>
                <div id="minhasReposicoes"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">üîî Meus Alertas de Falta - Feedback do Gestor</div>
                <div id="minhasFaltasComFeedback"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">üì¢ Informativos</div>
                <div id="informativosRepositor"></div>
            </div>
        </div>
    </div>

</div>

<div id="modalReposicao" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚úÖ Registrar Reposi√ß√£o</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalReposicao')">‚úñ Fechar</button>
        </div>
        <div class="form-group">
            <label style="font-weight:700">üîç Escolha como deseja identificar o produto:</label>
            <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
                <label style="cursor:pointer;padding:8px;background:#f8fbff;border-radius:6px">
                    <input type="radio" name="buscaTipo" value="codBarras" checked onchange="alterarTipoBusca()"> 
                    üìä C√≥digo de Barras
                </label>
                <label style="cursor:pointer;padding:8px;background:#f8fbff;border-radius:6px">
                    <input type="radio" name="buscaTipo" value="codProduto" onchange="alterarTipoBusca()"> 
                    üè∑Ô∏è C√≥digo do Produto
                </label>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>üìä C√≥digo de Barras</label>
                <input id="inputCodBarras" placeholder="Digite ou escaneie o c√≥digo" autocomplete="off">
            </div>
            <div class="form-group">
                <label>üè∑Ô∏è C√≥digo do Produto</label>
                <input id="inputCodProduto" placeholder="C√≥digo interno do produto" autocomplete="off" disabled>
            </div>
        </div>
        <div class="form-group">
            <label>üì¶ Nome do Produto *</label>
            <input id="inputProduto" placeholder="Ex: Arroz Tio Jo√£o 5kg" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>üìä Quantidade *</label>
                <input id="inputQuantidade" type="number" min="1" placeholder="Ex: 10" required>
            </div>
            <div class="form-group">
                <label>üìÖ Data Fabrica√ß√£o</label>
                <input id="inputDataFabricacao" type="date">
            </div>
            <div class="form-group">
                <label>‚è∞ Data Validade</label>
                <input id="inputDataValidade" type="date">
            </div>
        </div>
        <div class="form-group">
            <label>‚ö†Ô∏è Avaria</label>
            <select id="inputAvaria">
                <option value="nao">‚úÖ Sem Avaria</option>
                <option value="embalagem">üì¶ Embalagem Danificada</option>
                <option value="produto">üîß Produto Avariado</option>
            </select>
        </div>
        <div class="form-group">
            <label>üìù Observa√ß√µes</label>
            <textarea id="inputObservacao" rows="3" placeholder="Informa√ß√µes adicionais sobre a reposi√ß√£o..."></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn btn-repositor" onclick="salvarReposicao()">üíæ Salvar Reposi√ß√£o</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalReposicao')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalPerda" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚ö†Ô∏è Registrar Perda/Vencido</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalPerda')">‚úñ Fechar</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>üìä C√≥digo de Barras</label>
                <input id="inputCodBarrasPerda" placeholder="Opcional">
            </div>
            <div class="form-group">
                <label>üì¶ Nome do Produto *</label>
                <input id="inputProdutoPerda" placeholder="Ex: Leite Vencido" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>‚ö†Ô∏è Tipo *</label>
                <select id="inputTipoPerda">
                    <option value="vencido">‚è∞ Vencido</option>
                    <option value="avariado">üîß Avariado</option>
                    <option value="quebra">üíî Quebra</option>
                </select>
            </div>
            <div class="form-group">
                <label>üìä Quantidade *</label>
                <input id="inputQuantidadePerda" type="number" min="1" placeholder="Ex: 5" required>
            </div>
        </div>
        <div class="form-group">
            <label>üìù Motivo *</label>
            <textarea id="inputMotivoPerda" rows="3" placeholder="Descreva o motivo da perda..." required></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="salvarPerda()">üíæ Salvar Perda</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalPerda')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalInformativo" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üì¢ Enviar Informativo</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalInformativo')">‚úñ Fechar</button>
        </div>
        <div class="form-group">
            <label>üìã T√≠tulo *</label>
            <input id="inputTituloInfo" placeholder="Ex: Reuni√£o de Equipe" required>
        </div>
        <div class="form-group">
            <label>üìù Mensagem *</label>
            <textarea id="inputMensagemInfo" rows="6" placeholder="Digite a mensagem do informativo..." required></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="enviarInformativo()">üì§ Enviar</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalInformativo')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalDetalhesSetor" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 id="tituloDetalhesSetor">Detalhes do Setor</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalDetalhesSetor')">‚úñ Fechar</button>
        </div>
        <div id="conteudoDetalhesSetor"></div>
    </div>
</div>

<div id="modalConfiguracoes" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚öôÔ∏è Configura√ß√µes do Sistema</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalConfiguracoes')">‚úñ Fechar</button>
        </div>
        <p style="margin-bottom:16px;color:#435d73">Gerencie os dados mestres do sistema.</p>
        
        <div class="config-menu">
            <div class="config-menu-item" onclick="abrirModalFuncionarios()">
                <div class="icon">üßë‚Äçüíº</div>
                <div class="title">Gerenciar Funcion√°rios</div>
                <div class="description">Cadastre e edite os funcion√°rios da loja.</div>
            </div>
            
            <div class="config-menu-item" onclick="abrirModalSetores()">
                <div class="icon">üè™</div>
                <div class="title">Gerenciar Setores</div>
                <div class="description">Crie setores e atribua seus respons√°veis.</div>
            </div>
            
            <div class="config-menu-item" onclick="abrirModalUsuarios()">
                <div class="icon">üîë</div>
                <div class="title">Gerenciar Acessos (Usu√°rios)</div>
                <div class="description">Crie e remova logins para os funcion√°rios.</div>
            </div>
            
            <div class="config-menu-item" onclick="abrirModalEscalas()">
                <div class="icon">üóìÔ∏è</div>
                <div class="title">Gerenciar Escalas</div>
                <div class="description">Defina hor√°rios e folgas dos funcion√°rios.</div>
            </div>
        </div>
    </div>
</div>

<div id="modalFuncionarios" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üßë‚Äçüíº Gerenciar Funcion√°rios</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalFuncionarios'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>
        
        <div style="padding:14px;background:#f8fbff;border-radius:10px;margin-bottom:16px">
            <h4 style="color:#163d67;margin-bottom:10px" id="formTituloFuncionario">‚ûï Adicionar Novo Funcion√°rio</h4>
            <input type="hidden" id="inputFuncionarioId">
            <div class="form-row">
                <div class="form-group">
                    <label>üë§ Nome * (Usar mai√∫sculas, ex: JOAO)</label>
                    <input id="inputFuncionarioNome" placeholder="Ex: JOAO" required>
                </div>
                <div class="form-group">
                    <label>üìã Cargo *</label>
                    <input id="inputFuncionarioCargo" placeholder="Ex: Repositor" required>
                </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="salvarFuncionario()">üíæ Salvar</button>
                <button class="btn btn-secondary" onclick="limparFormulario('funcionario')" style="display:none;" id="btnLimparFuncionario">Cancelar Edi√ß√£o</button>
            </div>
        </div>
        
        <div>
            <h4 style="color:#163d67;margin-bottom:10px">üìã Funcion√°rios Atuais</h4>
            <div id="listaFuncionarios" class="item-list">
                </div>
        </div>
    </div>
</div>

<div id="modalSetores" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üè™ Gerenciar Setores</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalSetores'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>
        
        <div style="padding:14px;background:#f8fbff;border-radius:10px;margin-bottom:16px">
            <h4 style="color:#163d67;margin-bottom:10px" id="formTituloSetor">‚ûï Adicionar Novo Setor</h4>
            <input type="hidden" id="inputSetorId">
            <div class="form-row">
                <div class="form-group">
                    <label>üè™ Nome do Setor *</label>
                    <input id="inputSetorNome" placeholder="Ex: HORTIFRUTI" required>
                </div>
                <div class="form-group">
                    <label>üë§ Respons√°vel *</label>
                    <select id="inputSetorResponsavel">
                        <option value="">Selecione um funcion√°rio...</option>
                        </select>
                </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="salvarSetor()">üíæ Salvar</button>
                <button class="btn btn-secondary" onclick="limparFormulario('setor')" style="display:none;" id="btnLimparSetor">Cancelar Edi√ß√£o</button>
            </div>
        </div>
        
        <div>
            <h4 style="color:#163d67;margin-bottom:10px">üè™ Setores Atuais</h4>
            <div id="listaSetores" class="item-list">
                </div>
        </div>
    </div>
</div>

<div id="modalUsuarios" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üîë Gerenciar Acessos (Usu√°rios)</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalUsuarios'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>

        <div style="padding:14px;background:#f8fbff;border-radius:10px;margin-bottom:16px">
            <h4 style="color:#163d67;margin-bottom:10px">‚ûï Adicionar Novo Acesso</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>üë§ Funcion√°rio * (Nome que aparecer√° no sistema)</label>
                    <select id="inputUsuarioNovoNome">
                        <option value="">Selecione um funcion√°rio...</option>
                        </select>
                </div>
                <div class="form-group">
                    <label>‚úâÔ∏è E-mail de Acesso *</label>
                    <input id="inputEmailNovo" type="email" placeholder="email@dominio.com" required>
                </div>
                <div class="form-group">
                    <label>üîë Senha *</label>
                    <input id="inputSenhaNova" type="password" placeholder="M√≠nimo 6 caracteres" required>
                </div>
            </div>
            <button class="btn btn-primary" onclick="salvarNovoUsuario()">üíæ Salvar Acesso</button>
        </div>

        <div>
            <h4 style="color:#163d67;margin-bottom:10px">üìã Acessos Atuais (Logins)</h4>
            <p style="font-size:13px; color:#435d73; margin-bottom:10px;">Para remover um acesso, fa√ßa isso pelo Painel do Firebase (Authentication) por seguran√ßa.</p>
            <div id="listaUsuariosAtual" class="item-list">
                </div>
        </div>
    </div>
</div>

<div id="modalHistorico" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>‚úçÔ∏è Registrar Ocorr√™ncia/Servi√ßo</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalHistorico')">‚úñ Fechar</button>
        </div>
        <div class="form-group">
            <label>üìã Tipo de Registro *</label>
            <select id="inputHistoricoTipo">
                <option value="executado">‚úÖ Servi√ßo Executado / Resolvido</option>
                <option value="nao_executado">‚ö†Ô∏è Servi√ßo N√£o Executado / Pendente</option>
                <option value="observacao">‚ÑπÔ∏è Observa√ß√£o / Handoff</option>
            </select>
        </div>
        <div class="form-group">
            <label>üìù Descri√ß√£o * (O que foi feito ou o que est√° pendente?)</label>
            <textarea id="inputHistoricoDescricao" rows="6" placeholder="Ex: A c√¢mara fria foi verificada... Ex: Faltou fazer a contagem do dep√≥sito..." required></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="salvarHistoricoServico()">üíæ Salvar Registro</button>
            <button class="btn btn-secondary" onclick="fecharModal('modalHistorico')">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<div id="modalEscalas" class="modal">
    <div class="modal-inner card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>üóìÔ∏è Gerenciar Escalas</h3>
            <button class="btn btn-secondary" onclick="fecharModal('modalEscalas'); abrirModalConfiguracoes();">‚¨ÖÔ∏è Voltar</button>
        </div>
        
        <div class="form-group">
            <label>üë§ Selecione o Funcion√°rio *</label>
            <select id="selectFuncionarioEscala" onchange="carregarEscalaFuncionario(this.value)">
                <option value="">Selecione um funcion√°rio...</option>
            </select>
        </div>
        
        <div id="formEscala" style="display:none; padding:14px; background:#f8fbff; border-radius:10px; margin-top:16px;">
            <h4 style="color:#163d67; margin-bottom:10px">Definir Hor√°rios (Ex: 08:00-17:00, FOLGA, N/A)</h4>
            <div class="form-row" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                <div class="form-group">
                    <label>Domingo</label>
                    <input id="inputEscalaDom" placeholder="Ex: FOLGA">
                </div>
                <div class="form-group">
                    <label>Segunda</label>
                    <input id="inputEscalaSeg" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Ter√ßa</label>
                    <input id="inputEscalaTer" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Quarta</label>
                    <input id="inputEscalaQua" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Quinta</label>
                    <input id="inputEscalaQui" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>Sexta</label>
                    <input id="inputEscalaSex" placeholder="Ex: 08:00-17:00">
                </div>
                <div class="form-group">
                    <label>S√°bado</label>
                    <input id="inputEscalaSab" placeholder="Ex: 08:00-12:00">
                </div>
            </div>
            <button class="btn btn-primary" onclick="salvarEscalaFuncionario()">üíæ Salvar Escala</button>
        </div>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
    /* ======================================================================
    PASSO IMPORTANTE: COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI
    Voc√™ deve colar o objeto 'firebaseConfig' que voc√™ copiou do painel
    do Firebase. Veja o passo a passo no final da resposta.
    ======================================================================
    */
    const firebaseConfig = {
        apiKey: "COLE-SUA-API-KEY-AQUI",
        authDomain: "SEU-PROJETO.firebaseapp.com",
        projectId: "SEU-PROJETO-ID",
        storageBucket: "SEU-PROJETO.appspot.com",
        messagingSenderId: "SEU-SENDER-ID",
        appId: "SEU-APP-ID"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);

    // "Apelidos" para os servi√ßos do Firebase
    const db = firebase.firestore();    // Banco de Dados (Firestore)
    const auth = firebase.auth();     // Autentica√ß√£o (Login)
    
    console.log("Firebase Conectado!");
</script>


<script>
/* ======================================================================================
SISTEMA ALKINDA - JAVASCRIPT (v4.0 - Migrado para Firebase)
======================================================================================
*/

// Vari√°veis globais de dados (ser√£o preenchidas pelo Firebase)
let reposicoes = [];
let perdas = [];
let faltasGondola = [];
let informativos = [];
let funcionarios = [];
let setores = [];
let historicoServicos = []; 
let escalas = {}; 

// Estado da sess√£o
let tipoUsuario = ''; // 'gestor' ou 'repositor'
let funcionarioAtual = ''; // Nome do funcion√°rio logado
let usuarioAtual = null; // Objeto do Firebase Auth


/* ========================= FUN√á√ïES UTILIT√ÅRIAS ========================= */

function mostrarNotificacao(msg, tipo='success'){
    const div = document.createElement('div'); 
    div.className='notification '+(tipo==='error'?'error':'');
    div.innerHTML = (tipo==='error'?'<strong>‚ùå</strong> ':'<strong>‚úÖ</strong> ')+
                    `<span style="margin-left:8px">${msg}</span>`;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),3500);
}

function sanitize(str){
    if(!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// A fun√ß√£o 'resetarSistema' foi removida por seguran√ßa.

/* ========================= LOGIN E AUTENTICA√á√ÉO (FIREBASE) ========================= */

function abrirLogin(tipo){
    tipoUsuario = tipo; // Salva o tipo de dashboard que queremos abrir
    document.getElementById('loginForm').style.display = 'block';
    
    // Limpa campos e foca no e-mail
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginEmail').focus();
}

function fecharLogin(){ 
    document.getElementById('loginForm').style.display='none'; 
}

async function fazerLogin(){
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPass').value;
    const erroLogin = document.getElementById('loginError');
    
    if(!email || !pass){ 
        mostrarNotificacao('Preencha e-mail e senha','error'); 
        return; 
    }
    
    try {
        erroLogin.style.display = 'none';
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        
        // Login bem-sucedido
        usuarioAtual = userCredential.user;
        
        // Define o nome do funcion√°rio (importante para salvar registros)
        // Se o usu√°rio n√£o tiver um "Nome de Exibi√ß√£o", usamos o e-mail
        funcionarioAtual = usuarioAtual.displayName ? usuarioAtual.displayName.toUpperCase() : usuarioAtual.email;
        
        // A fun√ß√£o 'iniciarSessao' vai decidir se √© gestor ou repositor
        iniciarSessao();
        
        mostrarNotificacao('‚úÖ Login realizado com sucesso!');

    } catch(error) {
        // Trata erros de login
        console.error("Erro de login:", error.code, error.message);
        erroLogin.style.display = 'block';
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            erroLogin.textContent = '‚ùå E-mail ou senha incorretos.';
        } else {
            erroLogin.textContent = '‚ùå Erro ao tentar logar.';
        }
    }
}

/* ========================= GEST√ÉO DE SESS√ÉO ========================= */

function iniciarSessao(){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('mainScreen').style.display='block';
    document.getElementById('loginForm').style.display='none';

    // Inicia o carregamento de dados em tempo real
    carregarDadosEmTempoReal();

    // Decide qual dashboard mostrar
    // 'tipoUsuario' foi definido quando clicamos em "Gestor" ou "Repositor"
    if(tipoUsuario==='gestor'){
        document.getElementById('tituloSistema').textContent = 'üîê Painel do Gestor ('+funcionarioAtual+')';
        document.getElementById('dashboardGestor').style.display='block';
        document.getElementById('dashboardRepositor').style.display='none';
        // (os 'onSnapshot' v√£o chamar o carregarDashboardGestor())
    } else {
        document.getElementById('tituloSistema').textContent = 'üì¶ Painel do Repositor';
        document.getElementById('dashboardRepositor').style.display='block';
        document.getElementById('dashboardGestor').style.display='none';
        
        // No modo repositor, mostramos o <select> de funcion√°rio
        document.getElementById('selectFuncionarioDiv').style.display = 'block';
        // (o 'onSnapshot' de 'funcionarios' vai chamar 'carregarSelectFuncionarios()')
    }
}

/*
   carregarSelectFuncionarios: Popula lista de repositores (DIN√ÇMICO)
*/
function carregarSelectFuncionarios(){
    const select = document.getElementById('selectFuncionario');
    select.innerHTML = '<option value="">Selecione seu nome</option>';
    
    // Usa a vari√°vel 'funcionarios' global, que foi preenchida pelo Firebase
    funcionarios.forEach(func => {
        const setorInfo = setores.find(s => s.responsavel_nome.toUpperCase() === func.nome.toUpperCase());
        const nomeSetor = setorInfo ? setorInfo.nome : 'Sem Setor';
        
        // O valor do select √© o NOME (ex: JOAO), que √© usado para filtrar
        select.innerHTML += `<option value="${func.nome.toUpperCase()}">${func.nome} - ${nomeSetor}</option>`;
    });
    
    // Tenta pr√©-selecionar o funcion√°rio logado
    if (funcionarios.some(f => f.nome.toUpperCase() === funcionarioAtual)) {
        select.value = funcionarioAtual;
    }
    
    // Define o que acontece quando o repositor troca de nome no select
    select.onchange = function(){
        funcionarioAtual = this.value; // Atualiza o funcion√°rio ativo
        if(funcionarioAtual){
            carregarDashboardRepositor(); // Recarrega o painel com os dados desse funcion√°rio
        }
    }
    
    // Carrega o dashboard do repositor pela primeira vez (se j√° tiver um nome)
    if(funcionarioAtual) {
        carregarDashboardRepositor();
    }
}

async function sair(){ 
    if(confirm('Deseja realmente sair do sistema?')) {
        try {
            await auth.signOut(); // Faz logout do Firebase
            location.reload(); 
        } catch (error) {
            console.error("Erro ao sair:", error);
            mostrarNotificacao('Erro ao tentar sair.', 'error');
        }
    }
}

/* ========================= CARREGAMENTO DE DADOS (FIREBASE) ========================= */

// Esta fun√ß√£o central configura os "ouvintes" em tempo real
function carregarDadosEmTempoReal() {
    console.log("Iniciando carregamento de dados em tempo real...");

    // Ouve a cole√ß√£o 'funcionarios'
    db.collection("funcionarios").onSnapshot(snapshot => {
        funcionarios = [];
        snapshot.forEach(doc => funcionarios.push(doc.data()));
        console.log("Funcion√°rios carregados:", funcionarios.length);
        
        // Atualiza UIs que dependem de funcion√°rios
        if(tipoUsuario === 'repositor') carregarSelectFuncionarios();
        if(tipoUsuario === 'gestor') popularSelectResponsavel(); // Popula o modal de setores
    }, err => console.error("Erro ao ouvir funcionarios:", err));

    // Ouve a cole√ß√£o 'setores'
    db.collection("setores").onSnapshot(snapshot => {
        setores = [];
        snapshot.forEach(doc => setores.push(doc.data()));
        console.log("Setores carregados:", setores.length);
        
        // Atualiza UIs que dependem de setores
        if(tipoUsuario === 'gestor') carregarDashboardGestor();
        if(tipoUsuario === 'repositor' && funcionarioAtual) carregarDashboardRepositor();
    }, err => console.error("Erro ao ouvir setores:", err));
    
    // Ouve a cole√ß√£o 'reposicoes'
    db.collection("reposicoes").onSnapshot(snapshot => {
        reposicoes = [];
        snapshot.forEach(doc => reposicoes.push(doc.data()));
        if(tipoUsuario === 'gestor') carregarDashboardGestor();
        if(tipoUsuario === 'repositor' && funcionarioAtual) carregarDashboardRepositor();
    }, err => console.error("Erro ao ouvir reposicoes:", err));
    
    // Ouve a cole√ß√£o 'perdas'
    db.collection("perdas").onSnapshot(snapshot => {
        perdas = [];
        snapshot.forEach(doc => perdas.push(doc.data()));
        if(tipoUsuario === 'gestor') carregarDashboardGestor();
        if(tipoUsuario === 'repositor' && funcionarioAtual) carregarDashboardRepositor();
    }, err => console.error("Erro ao ouvir perdas:", err));

    // Ouve a cole√ß√£o 'faltas'
    db.collection("faltas").onSnapshot(snapshot => {
        faltasGondola = [];
        snapshot.forEach(doc => faltasGondola.push(doc.data()));
        if(tipoUsuario === 'gestor') carregarDashboardGestor();
        if(tipoUsuario === 'repositor' && funcionarioAtual) carregarDashboardRepositor();
    }, err => console.error("Erro ao ouvir faltas:", err));
    
    // Ouve a cole√ß√£o 'informativos'
    db.collection("informativos").onSnapshot(snapshot => {
        informativos = [];
        snapshot.forEach(doc => informativos.push(doc.data()));
        if(tipoUsuario === 'gestor') carregarDashboardGestor();
        if(tipoUsuario === 'repositor') carregarDashboardRepositor(); // Repositor tamb√©m v√™
    }, err => console.error("Erro ao ouvir informativos:", err));

    // Ouve a cole√ß√£o 'historicoServicos'
    db.collection("historicoServicos").onSnapshot(snapshot => {
        historicoServicos = [];
        snapshot.forEach(doc => historicoServicos.push(doc.data()));
        if(tipoUsuario === 'gestor') carregarDashboardGestor();
    }, err => console.error("Erro ao ouvir historicoServicos:", err));
    
    // Ouve a cole√ß√£o 'escalas'
    // Escalas s√£o salvas como 1 documento por funcion√°rio, dentro da cole√ß√£o 'escalas'
    db.collection("escalas").onSnapshot(snapshot => {
        escalas = {}; // √â um objeto, n√£o um array
        snapshot.forEach(doc => {
            // O ID do documento √© o NOME do funcion√°rio
            escalas[doc.id] = doc.data(); 
        });
        console.log("Escalas carregadas:", Object.keys(escalas).length);
        if(tipoUsuario === 'repositor' && funcionarioAtual) carregarDashboardRepositor();
    }, err => console.error("Erro ao ouvir escalas:", err));
}


/* ========================= DASHBOARD GESTOR (sem altera√ß√£o de l√≥gica) ========================= */
// As fun√ß√µes abaixo s√£o as mesmas, pois as vari√°veis globais (reposicoes, perdas, etc.)
// j√° foram preenchidas pelo Firebase.

function carregarDashboardGestor(){
    const hoje = new Date().toISOString().split('T')[0];
    
    const reposHoje = reposicoes.filter(r=>r.data===hoje);
    const perdasHoje = perdas.filter(p=>p.data===hoje);

    document.getElementById('totalReposicoes').textContent = reposHoje.length;
    document.getElementById('totalPerdas').textContent = perdasHoje.length;

    const alertas = [...new Set(faltasGondola.filter(f=>!f.resolvido).map(f=>f.setor))].length;
    document.getElementById('setoresAlerta').textContent = alertas;
    
    document.getElementById('totalSetores').textContent = setores.length;

    document.getElementById('totalPerdasGeral').textContent = perdas.length;
    document.getElementById('totalVencidos').textContent = perdas.filter(p=>p.tipo==='vencido').length;
    document.getElementById('totalAvariados').textContent = perdas.filter(p=>p.tipo==='avariado').length;
    document.getElementById('totalQuebras').textContent = perdas.filter(p=>p.tipo==='quebra').length;

    const filtroSetor = document.getElementById('filtroSetor'); 
    const valorAtual = filtroSetor.value; 
    filtroSetor.innerHTML = '<option value="">Todos os Setores</option>';
    setores.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(s=> {
        filtroSetor.innerHTML += `<option value="${s.nome}">${s.nome}</option>`;
    });
    filtroSetor.value = valorAtual; 

    // Atualiza se√ß√µes
    atualizarMapaSetores();
    atualizarListaReposicoes();
    atualizarListaPerdasDetalhada();
    atualizarRelatorioRepositor();
    atualizarListaInformativos();
    atualizarListaHistorico(); 
}

function atualizarMapaSetores(){
    const mapa = document.getElementById('mapaSetores'); 
    mapa.innerHTML = '';
    
    if (setores.length === 0) {
        mapa.innerHTML = '<div style="padding:14px;color:#6b7d8a;text-align:center">Nenhum setor cadastrado.</div>';
        return;
    }
    
    setores.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(setor=>{
        const falta = faltasGondola.find(f=>f.setor===setor.nome && !f.resolvido);
        const ultimaRepos = reposicoes.filter(r=>r.setor===setor.nome).pop();
        const div = document.createElement('div');
        div.className = 'setor-item '+(falta? 'setor-falta':'setor-ok');
        
        const responsavel = funcionarios.find(f => f.nome.toUpperCase() === setor.responsavel_nome.toUpperCase());
        const nomeResponsavel = responsavel ? responsavel.nome : (setor.responsavel_nome || 'N/A');
        
        div.innerHTML = `
            <div>
                <div style="font-weight:700">${setor.nome}</div>
                <div style="font-size:13px;color:#5b6b77">${nomeResponsavel}</div>
                ${ultimaRepos?`<div style="font-size:12px;color:#8fa6b9">√ölt: ${ultimaRepos.data} ${ultimaRepos.hora}</div>`:''}
                ${falta?`<div style="color:#dc3545;font-weight:700;margin-top:4px">üö® ${falta.produto}</div>`:''}
            </div>
            <div><span class="badge" style="background:${falta?'#dc3545':'#28a745'};color:#fff">${falta? 'FALTA':'OK'}</span></div>
        `;
        div.onclick = ()=> mostrarDetalhesSetor(setor.nome);
        mapa.appendChild(div);
    });
}

function mostrarDetalhesSetor(nomeSetor){
    const repoSet = reposicoes.filter(r=>r.setor===nomeSetor);
    const perdasSet = perdas.filter(p=>p.setor===nomeSetor);
    const faltasSet = faltasGondola.filter(f=>f.setor===nomeSetor);
    
    let html = `
        <div style="margin-bottom:18px;padding:12px;background:#f8fbff;border-radius:8px">
            <strong>üìä Estat√≠sticas do Setor</strong>
            <div style="margin-top:8px;display:flex;gap:16px;flex-wrap:wrap">
                <div>‚úÖ Reposi√ß√µes: <strong>${repoSet.length}</strong></div>
                <div>‚ö†Ô∏è Perdas: <strong>${perdasSet.length}</strong></div>
                <div>üö® Alertas: <strong>${faltasSet.length}</strong></div>
            </div>
        </div>
    `;

    html += '<h4 style="margin-top:16px;color:#163d67">üì¶ √öltimas Reposi√ß√µes</h4>';
    if(repoSet.length === 0){
        html += '<div style="padding:12px;color:#6b7d8a">Nenhuma reposi√ß√£o registrada</div>';
    } else {
        repoSet.slice(-10).reverse().forEach(r=>{
            html += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px">
                <div style="font-weight:700">üì¶ ${r.produto} <span style="color:#2F80ED">(${r.quantidade})</span></div>
                <div style="font-size:13px;color:#5b6b77;margin-top:4px">
                    üë§ ${r.responsavel} ‚Ä¢ üìÖ ${r.data} ‚è∞ ${r.hora}
                </div>
                ${r.codBarras ? `<div style="font-size:12px;color:#8fa6b9">üìä C√≥d. Barras: ${r.codBarras}</div>` : ''}
                ${r.codProduto ? `<div style="font-size:12px;color:#8fa6b9">üè∑Ô∏è C√≥d. Produto: ${r.codProduto}</div>` : ''}
            </div>`;
        });
    }
    
    if(faltasSet.length > 0){
        html += '<h4 style="margin-top:16px;color:#ffc107">üö® Alertas de Falta</h4>';
        faltasSet.slice().reverse().forEach(f=>{
            html += `<div style="padding:12px;border-radius:8px;background:#fffbea;margin-bottom:8px">
                <div style="font-weight:700">üö® ${f.produto}</div>
                <div style="font-size:13px;color:#5b6b77;margin-top:4px">
                    üë§ Reportado por ${f.responsavel} ‚Ä¢ üìÖ ${f.data} ‚è∞ ${f.hora}
                </div>
                <div style="margin-top:8px">
                    Status: ${f.resolvido?'<strong style="color:#28a745">‚úÖ RESOLVIDO</strong>':'<strong style="color:#dc3545">‚è≥ PENDENTE</strong>'}
                </div>
                ${f.resolvido ? `
                    <div style="margin-top:8px;padding:8px;background:#d4edda;border-radius:6px">
                        <div style="font-size:12px;font-weight:700;color:#28a745">üí¨ FEEDBACK:</div>
                        <div style="font-size:13px;margin-top:4px">${f.feedback||'Sem feedback'}</div>
                    </div>
                ` : `
                    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick='resolverFalta("${f.id}")'>‚úÖ Marcar como Resolvido</button>
                        <button class="btn btn-secondary" onclick='removerFalta("${f.id}")'>üóëÔ∏è Remover Alerta</button>
                    </div>
                `}
            </div>`;
        });
    }

    document.getElementById('tituloDetalhesSetor').textContent = 'üè™ ' + nomeSetor;
    document.getElementById('conteudoDetalhesSetor').innerHTML = html;
    document.getElementById('modalDetalhesSetor').style.display = 'block';
}


/* ========================= DASHBOARD REPOSITOR (sem altera√ß√£o de l√≥gica) ========================= */

function carregarDashboardRepositor(){
    // 'funcionarioAtual' √© definido pelo <select>
    if (!funcionarioAtual) {
        document.getElementById('meuSetor').textContent = 'SELECIONE SEU NOME';
        return;
    }
    
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    
    if(!setor) {
        document.getElementById('meuSetor').textContent = 'N√ÉO ASSOCIADO';
    } else {
        document.getElementById('meuSetor').textContent = setor.nome;
    }
    
    const hoje = new Date().toISOString().split('T')[0];
    
    // Filtra dados do funcion√°rio selecionado
    const minhasRep = reposicoes.filter(r=>r.responsavel===funcionarioAtual && r.data===hoje);
    const minhasPerd = perdas.filter(p=>p.responsavel===funcionarioAtual && p.data===hoje);
    const minhasFaltas = faltasGondola.filter(f=>f.responsavel===funcionarioAtual && !f.resolvido);
    
    document.getElementById('minhasReposicoesHoje').textContent = minhasRep.length;
    document.getElementById('minhasPerdasHoje').textContent = minhasPerd.length;
    document.getElementById('minhasFaltasAbertas').textContent = minhasFaltas.length;

    // Lista de registros
    const lista = document.getElementById('minhasReposicoes'); 
    lista.innerHTML='';
    const todos = [
        ...minhasRep.map(r=>({...r,'_tipo':'rep'})), 
        ...minhasPerd.map(p=>({...p,'_tipo':'perd'}))
    ].sort((a,b)=>b.timestamp-a.timestamp);
    
    if(!todos.length) {
        lista.innerHTML='<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum registro hoje</div>';
    } else {
        todos.forEach(r=>{
            if(r._tipo==='rep'){
                lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px">
                    <div style="font-weight:700">‚úÖ ${r.produto} <span style="color:#2F80ED">(${r.quantidade})</span></div>
                    <div style="font-size:13px;color:#5b6b77">‚è∞ ${r.hora}</div>
                </div>`;
            } else {
                lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fff5f5;margin-bottom:8px">
                    <div style="font-weight:700">‚ö†Ô∏è ${r.produto} <span style="color:#dc3545">(${r.quantidade})</span></div>
                    <div style="font-size:13px;color:#5b6b77">‚è∞ ${r.hora}</div>
                    <div style="font-size:13px;color:#6b7d8a">üìã Tipo: ${r.tipo}</div>
                </div>`;
            }
        });
    }
    
    atualizarFeedbacksFaltas();
    atualizarInformativosRepositor();
    atualizarMinhaEscala();
}

function atualizarMinhaEscala() {
    const div = document.getElementById('minhaEscala');
    div.innerHTML = '';
    
    const minhaEscala = escalas[funcionarioAtual]; // Pega do objeto global 'escalas'
    
    if (!minhaEscala) {
        div.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhuma escala definida.</div>';
        return;
    }
    
    let html = `
        <table class="escala-table">
            <tr><th>Dia</th><th>Hor√°rio</th></tr>
            <tr><th>Dom</th><td class="${minhaEscala.dom?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.dom || 'N/A')}</td></tr>
            <tr><th>Seg</th><td class="${minhaEscala.seg?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.seg || 'N/A')}</td></tr>
            <tr><th>Ter</th><td class="${minhaEscala.ter?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.ter || 'N/A')}</td></tr>
            <tr><th>Qua</th><td class="${minhaEscala.qua?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.qua || 'N/A')}</td></tr>
            <tr><th>Qui</th><td class="${minhaEscala.qui?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.qui || 'N/A')}</td></tr>
            <tr><th>Sex</th><td class="${minhaEscala.sex?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.sex || 'N/A')}</td></tr>
            <tr><th>S√°b</th><td class="${minhaEscala.sab?.toUpperCase() === 'FOLGA' ? 'folga' : ''}">${sanitize(minhaEscala.sab || 'N/A')}</td></tr>
        </table>
    `;
    div.innerHTML = html;
}

// Fun√ß√µes de lista (Gestor e Repositor) - Sem altera√ß√£o de l√≥gica
function atualizarListaReposicoes(){
    const lista = document.getElementById('listaReposicoes'); 
    lista.innerHTML='';
    const ultimas = reposicoes.slice(-10).reverse();
    if(!ultimas.length){ lista.innerHTML = '<div style="padding:14px;color:#6b7d8a;text-align:center">Nenhuma reposi√ß√£o recente</div>'; return; }
    ultimas.forEach(r=>{
        lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px">
            <div style="font-weight:700">üì¶ ${r.produto} <span style="color:#2F80ED">(${r.quantidade})</span></div>
            <div style="font-size:13px;color:#5b6b77;margin-top:4px">üè™ ${r.setor} ‚Ä¢ üë§ ${r.responsavel}</div>
            <div style="font-size:12px;color:#8fa6b9;margin-top:2px">üìÖ ${r.data} ‚è∞ ${r.hora}</div>
        </div>`;
    });
}
function atualizarListaPerdasDetalhada(){
    const lista = document.getElementById('listaPerdasDetalhada'); 
    lista.innerHTML='';
    const ultimas = perdas.slice(-10).reverse();
    if(!ultimas.length){ lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Sem perdas registradas</div>'; return; }
    ultimas.forEach(p=>{
        lista.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fff5f5;margin-bottom:8px">
            <div style="font-weight:700">‚ö†Ô∏è ${p.produto} <span style="color:#dc3545">(${p.quantidade})</span></div>
            <div style="font-size:13px;color:#5b6b77;margin-top:4px">üìã ${p.tipo.toUpperCase()} ‚Ä¢ üè™ ${p.setor} ‚Ä¢ üë§ ${p.responsavel}</div>
            <div style="font-size:12px;color:#8fa6b9;margin-top:2px">üìÖ ${p.data} ‚è∞ ${p.hora}</div>
            <div style="font-size:13px;color:#6b7d8a;margin-top:4px">üí¨ ${p.motivo}</div>
        </div>`;
    });
}
function atualizarRelatorioRepositor(){
    const rel = document.getElementById('relatorioRepositor'); 
    rel.innerHTML='';
    const dados = {};
    reposicoes.forEach(r=>{ dados[r.responsavel] = (dados[r.responsavel]||0)+1; });
    if(Object.keys(dados).length===0){ rel.innerHTML='<div style="padding:12px;color:#6b7d8a;text-align:center">Sem dados</div>'; return; }
    Object.entries(dados).sort((a,b)=>b[1]-a[1]).forEach(([nome,total])=>{
        rel.innerHTML += `<div style="padding:10px;border-radius:8px;background:#fbfeff;margin-bottom:8px;display:flex;justify-content:space-between">
            <div><strong>üë§ ${nome}</strong></div>
            <div><span style="color:#2F80ED;font-weight:700">${total}</span> reposi√ß√µes</div>
        </div>`;
    });
}
function atualizarListaInformativos(){
    const lista = document.getElementById('listaInformativos'); 
    lista.innerHTML='';
    if(!informativos.length){ lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum informativo</div>'; return; }
    informativos.slice(-10).reverse().forEach(info=>{
        lista.innerHTML += `<div class="informativo-item">
            <div style="font-weight:700">üì¢ ${info.titulo}</div>
            <div style="margin-top:6px;line-height:1.5">${info.mensagem}</div>
            <div style="font-size:12px;color:#6b7d8a;margin-top:8px">üìÖ ${info.data} ‚è∞ ${info.hora}</div>
        </div>`;
    });
}
function atualizarListaHistorico(){
    const lista = document.getElementById('listaHistoricoServicos'); 
    lista.innerHTML='';
    if(!historicoServicos.length){ 
        lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhuma ocorr√™ncia registrada</div>'; 
        return; 
    }
    const icones = { executado: '‚úÖ', nao_executado: '‚ö†Ô∏è', observacao: '‚ÑπÔ∏è' };
    historicoServicos.slice(-20).reverse().forEach(h => {
        const icone = icones[h.tipo] || '‚úçÔ∏è';
        const classe = h.tipo || 'observacao';
        lista.innerHTML += `
            <div class="historico-item ${classe}">
                <div style="font-weight:700">${icone} ${h.tipo.replace('_', ' ').toUpperCase()}</div>
                <div style="margin-top:6px;line-height:1.5;color:#213547">${h.descricao}</div>
                <div style="font-size:12px;color:#6b7d8a;margin-top:8px">
                    üë§ Registrado por: <strong>${h.autor}</strong> ‚Ä¢ üìÖ ${h.data} ‚è∞ ${h.hora}
                </div>
            </div>
        `;
    });
}
function atualizarFeedbacksFaltas(){
    const minhasFaltas = faltasGondola.filter(f=>f.responsavel===funcionarioAtual);
    const lista = document.getElementById('minhasFaltasComFeedback');
    lista.innerHTML = '';
    if(!minhasFaltas.length){
        lista.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum alerta de falta reportado</div>';
        return;
    }
    minhasFaltas.sort((a,b)=>{
        if(a.resolvido === b.resolvido) return b.timestamp - a.timestamp;
        return a.resolvido ? 1 : -1;
    });
    minhasFaltas.forEach(f=>{
        const statusIcon = f.resolvido ? '‚úÖ' : '‚è≥';
        const statusText = f.resolvido ? 'RESOLVIDO' : 'AGUARDANDO AN√ÅLISE';
        lista.innerHTML += `<div style="padding:12px;border-radius:8px;background:${f.resolvido?'#d4edda':'#fff3cd'};margin-bottom:10px;border-left:4px solid ${f.resolvido?'#28a745':'#ffc107'}">
            <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px">
                <div style="flex:1">
                    <div style="font-weight:700;color:#213547">üö® ${f.produto}</div>
                    <div style="font-size:13px;color:#5b6b77;margin-top:4px">üìÖ ${f.data} ‚è∞ ${f.hora} | üè™ ${f.setor}</div>
                </div>
                <div><span style="padding:4px 12px;background:${f.resolvido?'#28a745':'#ffc107'};color:#fff;border-radius:12px;font-size:12px;font-weight:700">${statusIcon} ${statusText}</span></div>
            </div>
            ${f.resolvido ? `
                <div style="margin-top:10px;padding:10px;background:#fff;border-radius:6px">
                    <div style="font-size:12px;font-weight:700;color:#28a745;margin-bottom:4px">üí¨ FEEDBACK DO GESTOR:</div>
                    <div style="font-size:13px;color:#213547">${f.feedback || 'Sem observa√ß√µes'}</div>
                </div>
            ` : `
                <div style="margin-top:8px;font-size:12px;color:#856404">‚è≥ Aguardando an√°lise e feedback...</div>
            `}
        </div>`;
    });
}
function atualizarInformativosRepositor(){
    const listaInfo = document.getElementById('informativosRepositor'); 
    listaInfo.innerHTML='';
    if(!informativos.length){ listaInfo.innerHTML = '<div style="padding:12px;color:#6b7d8a;text-align:center">Nenhum informativo</div>'; return; }
    informativos.slice(-10).reverse().forEach(info=>{
        listaInfo.innerHTML += `<div class="informativo-item">
            <div style="font-weight:700">üì¢ ${info.titulo}</div>
            <div style="margin-top:6px;line-height:1.5">${info.mensagem}</div>
            <div style="font-size:12px;color:#6b7d8a;margin-top:8px">üìÖ ${info.data} ‚è∞ ${info.hora}</div>
        </div>`;
    });
}


/* ========================= A√á√ïES: MODAIS E SALVAMENTO (FIREBASE) ========================= */

// Fun√ß√µes de abrir modais (sem altera√ß√£o)
function abrirModalReposicao(){ 
    document.getElementById('modalReposicao').style.display='block';
    document.getElementById('inputProduto').value = '';
    document.getElementById('inputQuantidade').value = '';
    document.getElementById('inputCodBarras').value = '';
    document.getElementById('inputCodProduto').value = '';
    document.getElementById('inputDataFabricacao').value = '';
    document.getElementById('inputDataValidade').value = '';
    document.getElementById('inputAvaria').value = 'nao';
    document.getElementById('inputObservacao').value = '';
    alterarTipoBusca();
}
function abrirModalPerda(){ 
    document.getElementById('modalPerda').style.display='block';
    document.getElementById('inputCodBarrasPerda').value = '';
    document.getElementById('inputProdutoPerda').value = '';
    document.getElementById('inputTipoPerda').value = 'vencido';
    document.getElementById('inputQuantidadePerda').value = '';
    document.getElementById('inputMotivoPerda').value = '';
}
function abrirModalInformativo(){ 
    document.getElementById('modalInformativo').style.display='block';
    document.getElementById('inputTituloInfo').value = '';
    document.getElementById('inputMensagemInfo').value = '';
}
function abrirModalHistorico(){
    document.getElementById('modalHistorico').style.display='block';
    document.getElementById('inputHistoricoTipo').value = 'executado';
    document.getElementById('inputHistoricoDescricao').value = '';
    document.getElementById('inputHistoricoDescricao').focus();
}
function fecharModal(id){ document.getElementById(id).style.display='none'; }
function alterarTipoBusca(){
    const tipo = document.querySelector('input[name="buscaTipo"]:checked').value;
    const codBarras = document.getElementById('inputCodBarras');
    const codProduto = document.getElementById('inputCodProduto');
    if(tipo === 'codBarras'){
        codBarras.disabled = false; codBarras.required = true;
        codProduto.disabled = true; codProduto.required = false; codProduto.value = '';
        codBarras.focus();
    } else {
        codBarras.disabled = true; codBarras.required = false; codBarras.value = '';
        codProduto.disabled = false; codProduto.required = true;
        codProduto.focus();
    }
}


/*
   Fun√ß√µes de SALVAR (Migradas para Firebase)
   Todas usam 'async/await' para esperar a resposta do banco
*/

async function salvarReposicao(){
    const produto = document.getElementById('inputProduto').value.trim();
    const quantidade = parseInt(document.getElementById('inputQuantidade').value);
    const codBarras = document.getElementById('inputCodBarras').value.trim();
    const codProduto = document.getElementById('inputCodProduto').value.trim();
    
    if(!produto || !quantidade || !codBarras && !codProduto){ 
        mostrarNotificacao('Preencha nome, quantidade e c√≥digo','error'); 
        return; 
    }

    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    const agora = new Date();
    const id = agora.getTime().toString(); // ID √∫nico
    
    const repos = {
        id: id,
        produto: sanitize(produto),
        quantidade,
        codBarras: sanitize(codBarras),
        codProduto: sanitize(codProduto),
        dataFabricacao: document.getElementById('inputDataFabricacao').value,
        dataValidade: document.getElementById('inputDataValidade').value,
        avaria: document.getElementById('inputAvaria').value,
        observacao: sanitize(document.getElementById('inputObservacao').value.trim()),
        setor: setor ? setor.nome : '‚Äî',
        responsavel: funcionarioAtual, // 'funcionarioAtual' √© o NOME do <select>
        data: agora.toISOString().split('T')[0],
        hora: agora.toLocaleTimeString('pt-BR'),
        timestamp: agora.getTime()
    };
    
    try {
        await db.collection("reposicoes").doc(id).set(repos);
        fecharModal('modalReposicao');
        mostrarNotificacao('‚úÖ Reposi√ß√£o registrada com sucesso!');
        // N√£o precisa recarregar o dashboard, o 'onSnapshot' faz isso
    } catch (e) {
        console.error("Erro ao salvar reposi√ß√£o: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}

async function salvarPerda(){
    const produto = document.getElementById('inputProdutoPerda').value.trim();
    const quantidade = parseInt(document.getElementById('inputQuantidadePerda').value);
    const motivo = document.getElementById('inputMotivoPerda').value.trim();
    
    if(!produto || !quantidade || !motivo){ 
        mostrarNotificacao('Preencha todos os campos obrigat√≥rios','error'); 
        return; 
    }
    
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    const agora = new Date();
    const id = agora.getTime().toString();
    
    const p = { 
        id: id, 
        produto: sanitize(produto), 
        tipo: document.getElementById('inputTipoPerda').value, 
        quantidade, 
        motivo: sanitize(motivo), 
        codBarras: sanitize(document.getElementById('inputCodBarrasPerda').value.trim()), 
        setor: setor ? setor.nome : '‚Äî', 
        responsavel: funcionarioAtual, 
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        timestamp: agora.getTime() 
    };
    
    try {
        await db.collection("perdas").doc(id).set(p);
        fecharModal('modalPerda'); 
        mostrarNotificacao('‚úÖ Perda registrada com sucesso!');
    } catch (e) {
        console.error("Erro ao salvar perda: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}

async function registrarFalta(){
    const produto = prompt('üö® Digite o nome do produto que est√° em falta:'); 
    if(!produto || !produto.trim()) return;
    
    const setor = setores.find(s=> s.responsavel_nome.toUpperCase() === funcionarioAtual);
    const agora = new Date();
    const id = agora.getTime().toString();
    
    const f = { 
        id: id, 
        produto: sanitize(produto.trim()), 
        setor: setor ? setor.nome : '‚Äî', 
        responsavel: funcionarioAtual, 
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        resolvido: false, 
        timestamp: agora.getTime() 
    };
    
    try {
        await db.collection("faltas").doc(id).set(f);
        mostrarNotificacao('üö® Falta registrada! O gestor ser√° notificado.');
    } catch (e) {
        console.error("Erro ao registrar falta: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}

async function resolverFalta(id){
    const msg = prompt('üí¨ Digite um feedback para o repositor:\n(ex: "Produto reabastecido", "Verificar com fornecedor")');
    if(msg === null) return;
    
    const dadosUpdate = {
        resolvido: true,
        resolvidoPor: funcionarioAtual, // 'funcionarioAtual' do gestor
        resolvidoEm: new Date().toISOString(),
        feedback: sanitize(msg.trim()) || 'Resolvido sem observa√ß√µes'
    };
    
    try {
        await db.collection("faltas").doc(id).update(dadosUpdate);
        mostrarNotificacao('‚úÖ Falta marcada como resolvida!');
        // O 'onSnapshot' vai atualizar a UI automaticamente
    } catch (e) {
        console.error("Erro ao resolver falta: ", e);
        mostrarNotificacao('‚ùå Erro ao atualizar na nuvem.', 'error');
    }
}

async function removerFalta(id){
    if(!confirm('Confirma remo√ß√£o deste alerta?')) return;
    
    try {
        await db.collection("faltas").doc(id).delete();
        mostrarNotificacao('üóëÔ∏è Alerta removido.');
        fecharModal('modalDetalhesSetor');
        // 'onSnapshot' atualiza a UI
    } catch (e) {
        console.error("Erro ao remover falta: ", e);
        mostrarNotificacao('‚ùå Erro ao remover da nuvem.', 'error');
    }
}

async function enviarInformativo(){
    const titulo = document.getElementById('inputTituloInfo').value.trim();
    const mensagem = document.getElementById('inputMensagemInfo').value.trim();
    
    if(!titulo || !mensagem){ 
        mostrarNotificacao('Preencha t√≠tulo e mensagem','error'); 
        return; 
    }
    
    const agora = new Date();
    const id = agora.getTime().toString();

    const info = { 
        id: id, 
        titulo: sanitize(titulo), 
        mensagem: sanitize(mensagem), 
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        timestamp: agora.getTime() 
    };
    
    try {
        await db.collection("informativos").doc(id).set(info);
        fecharModal('modalInformativo'); 
        mostrarNotificacao('üì¢ Informativo enviado com sucesso!');
    } catch (e) {
        console.error("Erro ao enviar informativo: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}

async function salvarHistoricoServico(){
    const tipo = document.getElementById('inputHistoricoTipo').value;
    const descricao = document.getElementById('inputHistoricoDescricao').value.trim();
    
    if(!descricao){ 
        mostrarNotificacao('Preencha a descri√ß√£o da ocorr√™ncia','error'); 
        return; 
    }
    
    const agora = new Date();
    const id = agora.getTime().toString();
    
    const novoRegistro = { 
        id: id, 
        tipo: tipo,
        descricao: sanitize(descricao), 
        autor: funcionarioAtual, // Salva quem registrou
        data: agora.toISOString().split('T')[0], 
        hora: agora.toLocaleTimeString('pt-BR'), 
        timestamp: agora.getTime() 
    };
    
    try {
        await db.collection("historicoServicos").doc(id).set(novoRegistro);
        fecharModal('modalHistorico'); 
        mostrarNotificacao('‚úÖ Registro de hist√≥rico salvo!');
    } catch (e) {
        console.error("Erro ao salvar hist√≥rico: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}


/*
    ======================================================================
    NOVAS FUN√á√ïES (v4.0): GERENCIAMENTO (Migradas para Firebase)
    ======================================================================
*/

// Limpa formul√°rios de edi√ß√£o
function limparFormulario(tipo) {
    if (tipo === 'funcionario') {
        document.getElementById('formTituloFuncionario').textContent = '‚ûï Adicionar Novo Funcion√°rio';
        document.getElementById('inputFuncionarioId').value = '';
        document.getElementById('inputFuncionarioNome').value = '';
        document.getElementById('inputFuncionarioCargo').value = '';
        document.getElementById('btnLimparFuncionario').style.display = 'none';
        document.getElementById('inputFuncionarioNome').disabled = false;
    } else if (tipo === 'setor') {
        document.getElementById('formTituloSetor').textContent = '‚ûï Adicionar Novo Setor';
        document.getElementById('inputSetorId').value = '';
        document.getElementById('inputSetorNome').value = '';
        document.getElementById('inputSetorResponsavel').value = '';
        document.getElementById('btnLimparSetor').style.display = 'none';
    }
}

// ---- CONFIGURA√á√ïES ----
function abrirModalConfiguracoes() {
    fecharModal('modalFuncionarios');
    fecharModal('modalSetores');
    fecharModal('modalUsuarios');
    fecharModal('modalEscalas');
    document.getElementById('modalConfiguracoes').style.display = 'block';
}

// ---- FUNCION√ÅRIOS ----
function abrirModalFuncionarios() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalFuncionarios').style.display = 'block';
    limparFormulario('funcionario');
    carregarModalFuncionarios();
}

function carregarModalFuncionarios() {
    // A vari√°vel 'funcionarios' j√° est√° atualizada pelo 'onSnapshot'
    const listaDiv = document.getElementById('listaFuncionarios');
    listaDiv.innerHTML = '';
    
    if (funcionarios.length === 0) {
        listaDiv.innerHTML = 'Nenhum funcion√°rio cadastrado.';
        return;
    }
    
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        const div = document.createElement('div');
        div.className = 'item-list-item';
        
        let userInfo = `<div><strong>üë§ ${f.nome}</strong><div style="font-size:13px;color:#6b7d8a">${f.cargo}</div></div>`;
        
        // O ID do funcion√°rio agora √© o NOME dele em mai√∫sculas
        let actions = `<div class="item-list-actions">
            <button class="btn btn-edit" onclick='editarFuncionario("${f.id}")'>‚úèÔ∏è Editar</button>
            <button class="btn btn-danger" onclick='removerFuncionario("${f.id}")'>üóëÔ∏è Remover</button>
        </div>`;
        
        div.innerHTML = userInfo + actions;
        listaDiv.appendChild(div);
    });
}

async function salvarFuncionario() {
    const idInput = document.getElementById('inputFuncionarioId').value;
    const nome = document.getElementById('inputFuncionarioNome').value.trim().toUpperCase();
    const cargo = document.getElementById('inputFuncionarioCargo').value.trim();
    
    if (!nome || !cargo) {
        mostrarNotificacao('Preencha nome e cargo', 'error');
        return;
    }
    
    // O ID do documento ser√° o pr√≥prio nome do funcion√°rio
    const id = idInput || nome; // Se est√° editando, usa o ID antigo, se n√£o, usa o nome novo
    const idNovo = nome; // O ID final ser√° o novo nome
    
    const novoFuncionario = {
        id: idNovo, // Salvamos o ID dentro do documento por facilidade
        nome: nome,
        cargo: cargo
    };

    try {
        // Se o ID mudou (editou o nome)
        if (idInput && idInput !== idNovo) {
            // Precisa apagar o antigo e criar um novo
            await db.collection("funcionarios").doc(idInput).delete();
            console.log("Funcion√°rio antigo removido:", idInput);
            
            // TODO: Atualizar setores e escalas que usavam o nome antigo (l√≥gica mais complexa)
        }
        
        // Cria ou atualiza o documento com o novo ID/Nome
        await db.collection("funcionarios").doc(idNovo).set(novoFuncionario);
        
        mostrarNotificacao('‚úÖ Funcion√°rio salvo na nuvem!');
        limparFormulario('funcionario');
        // 'onSnapshot' vai recarregar a lista
        
    } catch (e) {
        console.error("Erro ao salvar funcion√°rio: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}

function editarFuncionario(id) {
    const func = funcionarios.find(f => f.id === id);
    if (func) {
        document.getElementById('formTituloFuncionario').textContent = '‚úèÔ∏è Editando Funcion√°rio';
        document.getElementById('inputFuncionarioId').value = func.id;
        document.getElementById('inputFuncionarioNome').value = func.nome;
        document.getElementById('inputFuncionarioCargo').value = func.cargo;
        document.getElementById('btnLimparFuncionario').style.display = 'inline-block';
    }
}

async function removerFuncionario(id) {
    const func = funcionarios.find(f => f.id === id);
    if (!func) return;
    
    if (confirm(`Deseja remover ${func.nome} da lista de funcion√°rios? \n\n‚ö†Ô∏è Aten√ß√£o: Isso N√ÉO remove o login (e-mail) dele. Para remover o login, acesse o Painel do Firebase.`)) {
        try {
            await db.collection("funcionarios").doc(id).delete();
            
            // TODO: Limpar responsabilidade de setores e escalas
            
            mostrarNotificacao('üóëÔ∏è Funcion√°rio removido.');
            // 'onSnapshot' recarrega a lista
        } catch (e) {
            console.error("Erro ao remover funcion√°rio: ", e);
            mostrarNotificacao('‚ùå Erro ao remover da nuvem.', 'error');
        }
    }
}


// ---- SETORES ----
function abrirModalSetores() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalSetores').style.display = 'block';
    limparFormulario('setor');
    carregarModalSetores();
    popularSelectResponsavel();
}

function popularSelectResponsavel() {
    // 'funcionarios' j√° est√° carregado pelo 'onSnapshot'
    const select = document.getElementById('inputSetorResponsavel');
    const valorAtual = select.value; // Salva o valor atual
    
    select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>';
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        select.innerHTML += `<option value="${f.nome}">${f.nome} - (${f.cargo})</option>`;
    });
    
    select.value = valorAtual; // Restaura, se poss√≠vel
}

function carregarModalSetores() {
    // 'setores' j√° est√° carregado pelo 'onSnapshot'
    const listaDiv = document.getElementById('listaSetores');
    listaDiv.innerHTML = '';
    
    if (setores.length === 0) {
        listaDiv.innerHTML = 'Nenhum setor cadastrado.';
        return;
    }
    
    setores.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(s => {
        const div = document.createElement('div');
        div.className = 'item-list-item';
        
        let setorInfo = `<div><strong>üè™ ${s.nome}</strong><div style="font-size:13px;color:#6b7d8a">Respons√°vel: ${s.responsavel_nome}</div></div>`;
        let actions = `<div class="item-list-actions">
            <button class="btn btn-edit" onclick='editarSetor("${s.id}")'>‚úèÔ∏è Editar</button>
            <button class="btn btn-danger" onclick='removerSetor("${s.id}")'>üóëÔ∏è Remover</button>
        </div>`;
        
        div.innerHTML = setorInfo + actions;
        listaDiv.appendChild(div);
    });
}

async function salvarSetor() {
    const idInput = document.getElementById('inputSetorId').value;
    const nome = document.getElementById('inputSetorNome').value.trim().toUpperCase();
    const responsavel = document.getElementById('inputSetorResponsavel').value;
    
    if (!nome || !responsavel) {
        mostrarNotificacao('Preencha nome e respons√°vel', 'error');
        return;
    }
    
    // O ID do documento ser√° o pr√≥prio nome do setor
    const id = idInput || nome;
    const idNovo = nome;
    
    const novoSetor = {
        id: idNovo,
        nome: nome,
        responsavel_nome: responsavel
    };

    try {
        if (idInput && idInput !== idNovo) {
            await db.collection("setores").doc(idInput).delete();
        }
        await db.collection("setores").doc(idNovo).set(novoSetor);
        
        mostrarNotificacao('‚úÖ Setor salvo na nuvem!');
        limparFormulario('setor');
        // 'onSnapshot' recarrega
    } catch (e) {
        console.error("Erro ao salvar setor: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}

function editarSetor(id) {
    const setor = setores.find(s => s.id === id);
    if (setor) {
        popularSelectResponsavel(); 
        
        document.getElementById('formTituloSetor').textContent = '‚úèÔ∏è Editando Setor';
        document.getElementById('inputSetorId').value = setor.id;
        document.getElementById('inputSetorNome').value = setor.nome;
        document.getElementById('inputSetorResponsavel').value = setor.responsavel_nome;
        document.getElementById('btnLimparSetor').style.display = 'inline-block';
    }
}

async function removerSetor(id) {
    if (confirm(`Deseja remover o setor ${id}?`)) {
        try {
            await db.collection("setores").doc(id).delete();
            mostrarNotificacao('üóëÔ∏è Setor removido.');
            // 'onSnapshot' recarrega
        } catch (e) {
            console.error("Erro ao remover setor: ", e);
            mostrarNotificacao('‚ùå Erro ao remover da nuvem.', 'error');
        }
    }
}


// ---- ACESSOS (USU√ÅRIOS / LOGIN) ----
function abrirModalUsuarios() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalUsuarios').style.display = 'block';
    carregarModalUsuarios();
    popularSelectUsuarios();
    
    // Limpa campos
    document.getElementById('inputEmailNovo').value = '';
    document.getElementById('inputSenhaNova').value = '';
}

function popularSelectUsuarios() {
    // 'funcionarios' j√° est√° carregado
    const select = document.getElementById('inputUsuarioNovoNome');
    select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>';
    
    // TODO: Filtrar funcion√°rios que AINDA N√ÉO t√™m login
    
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        select.innerHTML += `<option value="${f.nome}">${f.nome} - (${f.cargo})</option>`;
    });
}

function carregarModalUsuarios() {
    // Esta fun√ß√£o agora √© dif√≠cil, pois o Firebase Auth n√£o
    // permite listar todos os usu√°rios facilmente pelo client.
    // Vamos simplificar e mostrar apenas o usu√°rio ATUAL.
    const listaDiv = document.getElementById('listaUsuariosAtual');
    listaDiv.innerHTML = '';
    
    if (usuarioAtual) {
         const div = document.createElement('div');
        div.className = 'item-list-item';
        let userInfo = `<strong>üë§ ${usuarioAtual.displayName || usuarioAtual.email}</strong> (Voc√™)`;
        div.innerHTML = `<div>${userInfo}</div>`;
        listaDiv.appendChild(div);
    }
}

async function salvarNovoUsuario() {
    const nomeFuncionario = document.getElementById('inputUsuarioNovoNome').value.toUpperCase();
    const email = document.getElementById('inputEmailNovo').value;
    const pass = document.getElementById('inputSenhaNova').value;
    
    if (!nomeFuncionario || !email || !pass) {
        mostrarNotificacao('Preencha nome do funcion√°rio, e-mail e senha', 'error');
        return;
    }
    if (pass.length < 6) {
        mostrarNotificacao('A senha deve ter no m√≠nimo 6 caracteres', 'error');
        return;
    }
    
    try {
        // 1. Cria o usu√°rio no Firebase Authentication
        const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
        
        // 2. Adiciona o "Nome" (ex: JOAO) ao perfil dele
        await userCredential.user.updateProfile({
            displayName: nomeFuncionario
        });

        mostrarNotificacao(`‚úÖ Acesso criado para ${nomeFuncionario}!`);
        
        document.getElementById('inputUsuarioNovoNome').value = '';
        document.getElementById('inputEmailNovo').value = '';
        document.getElementById('inputSenhaNova').value = '';

    } catch (error) {
        console.error("Erro ao criar usu√°rio:", error);
        if (error.code == 'auth/email-already-in-use') {
            mostrarNotificacao('‚ùå Este e-mail j√° est√° em uso.', 'error');
        } else {
            mostrarNotificacao('‚ùå Erro ao criar usu√°rio.', 'error');
        }
    }
}

// A fun√ß√£o 'removerUsuario' foi desativada por seguran√ßa.


// ---- ESCALAS ----
function abrirModalEscalas() {
    fecharModal('modalConfiguracoes');
    document.getElementById('modalEscalas').style.display = 'block';
    document.getElementById('formEscala').style.display = 'none';
    
    const select = document.getElementById('selectFuncionarioEscala');
    select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>';
    
    funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
        select.innerHTML += `<option value="${f.nome}">${f.nome} - (${f.cargo})</option>`;
    });
}

function carregarEscalaFuncionario(nome) {
    const form = document.getElementById('formEscala');
    if (!nome) {
        form.style.display = 'none';
        return;
    }
    
    // 'escalas' √© um objeto onde a chave √© o nome do funcion√°rio
    const escala = escalas[nome] || {}; // Pega escala ou objeto vazio
    
    document.getElementById('inputEscalaDom').value = escala.dom || '';
    document.getElementById('inputEscalaSeg').value = escala.seg || '';
    document.getElementById('inputEscalaTer').value = escala.ter || '';
    document.getElementById('inputEscalaQua').value = escala.qua || '';
    document.getElementById('inputEscalaQui').value = escala.qui || '';
    document.getElementById('inputEscalaSex').value = escala.sex || '';
    document.getElementById('inputEscalaSab').value = escala.sab || '';
    
    form.style.display = 'block';
}

async function salvarEscalaFuncionario() {
    const nome = document.getElementById('selectFuncionarioEscala').value;
    if (!nome) {
        mostrarNotificacao('Nenhum funcion√°rio selecionado', 'error');
        return;
    }
    
    const novaEscala = {
        dom: sanitize(document.getElementById('inputEscalaDom').value.trim().toUpperCase()),
        seg: sanitize(document.getElementById('inputEscalaSeg').value.trim().toUpperCase()),
        ter: sanitize(document.getElementById('inputEscalaTer').value.trim().toUpperCase()),
        qua: sanitize(document.getElementById('inputEscalaQua').value.trim().toUpperCase()),
        qui: sanitize(document.getElementById('inputEscalaQui').value.trim().toUpperCase()),
        sex: sanitize(document.getElementById('inputEscalaSex').value.trim().toUpperCase()),
        sab: sanitize(document.getElementById('inputEscalaSab').value.trim().toUpperCase())
    };
    
    try {
        // Salva na cole√ß√£o 'escalas', usando o NOME do funcion√°rio como ID do documento
        await db.collection("escalas").doc(nome).set(novaEscala);
        mostrarNotificacao(`‚úÖ Escala de ${nome} salva com sucesso!`);
        // 'onSnapshot' vai atualizar
    } catch (e) {
        console.error("Erro ao salvar escala: ", e);
        mostrarNotificacao('‚ùå Erro ao salvar na nuvem.', 'error');
    }
}


/* ========================= FILTROS E EXPORTA√á√ïES (Sem altera√ß√£o) ========================= */

function aplicarFiltros(){
    // Esta fun√ß√£o agora apenas filtra os dados que j√° est√£o na mem√≥ria
    // (carregados pelo Firebase). A l√≥gica √© a mesma.
    const data = document.getElementById('filtroData').value;
    const setorFiltro = document.getElementById('filtroSetor').value;
    
    // Filtra c√≥pias dos arrays globais
    let reposFil = [...reposicoes]; 
    let perdasFil = [...perdas];
    
    if(data){ 
        reposFil = reposFil.filter(r=>r.data===data); 
        perdasFil = perdasFil.filter(p=>p.data===data); 
    }
    if(setorFiltro){ 
        reposFil = reposFil.filter(r=>r.setor===setorFiltro); 
        perdasFil = perdasFil.filter(p=>p.setor===setorFiltro); 
    }
    
    // TODO: Atualizar a UI com os dados filtrados
    // (Esta parte da l√≥gica n√£o estava completa no original)
    mostrarNotificacao('üîç Filtros aplicados! (UI precisa ser atualizada com dados filtrados)');
    
    // Por enquanto, vamos apenas recarregar o dashboard (limpando filtros)
    // Para implementar filtros de verdade, as fun√ß√µes 'atualizarLista...'
    // precisariam aceitar 'reposFil' e 'perdasFil' como par√¢metros.
}
function limparFiltros(){
    document.getElementById('filtroData').value = '';
    document.getElementById('filtroSetor').value = '';
    // Recarrega o dashboard com os dados completos (dos arrays globais)
    carregarDashboardGestor();
    mostrarNotificacao('üîÑ Filtros removidos');
}
function gerarPDF(){ window.print(); }

function exportarBackupJSON(){
    // Esta fun√ß√£o agora faz backup dos dados em mem√≥ria
    const backup = {
        versao: '4.0-firebase-snapshot',
        dataExportacao: new Date().toISOString(),
        funcionarios: funcionarios,
        setores: setores,
        reposicoes: reposicoes,
        perdas: perdas,
        faltasGondola: faltasGondola,
        informativos: informativos,
        historicoServicos: historicoServicos,
        escalas: escalas
    };
    // (O backup de usu√°rios/logins deve ser feito pelo Firebase)
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_alkinda_snapshot_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    mostrarNotificacao('üíæ Backup dos dados atuais exportado!');
}

function importarBackupJSON(){
    if(!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° SOBRESCREVER os dados na nuvem com este arquivo!\n\nUse apenas para restaura√ß√£o de desastres. Deseja continuar?')){
        return;
    }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async function(e){
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(event){
            try {
                const backup = JSON.parse(event.target.result);
                if(!backup.reposicoes || !backup.perdas || !backup.funcionarios){
                    throw new Error('Arquivo de backup inv√°lido');
                }
                
                // RESTAURA√á√ÉO (SOBRESCRITA NA NUVEM)
                // Isso √© complexo e usa "Batch Writes" do Firebase
                
                // Por seguran√ßa, esta fun√ß√£o ser√° simplificada para N√ÉO
                // fazer a importa√ß√£o, apenas mostrar uma mensagem.
                // A importa√ß√£o deve ser feita via um script de admin separado.
                
                mostrarNotificacao('Fun√ß√£o de importa√ß√£o desativada por seguran√ßa. Restaure pelo painel do Firebase.', 'error');

            } catch(erro) {
                mostrarNotificacao('‚ùå Erro ao ler backup: ' + erro.message, 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
function exportarRelatorioCSV(){
    let lines = [];
    lines.push('TIPO;ID;DATA;HORA;SETOR;RESPONSAVEL;PRODUTO;QTD;COD_BARRAS;COD_PRODUTO;TIPO_EXTRA;MOTIVO_OBS;FEEDBACK;STATUS');
    reposicoes.forEach(r=>{ lines.push(`REPOSICAO;${r.id};${r.data};${r.hora};${r.setor};${r.responsavel};${r.produto};${r.quantidade};${r.codBarras||''};${r.codProduto||''};${r.avaria||''};"${(r.observacao||'').replace(/"/g,'""')}";;COMPLETO`); });
    perdas.forEach(p=>{ lines.push(`PERDA;${p.id};${p.data};${p.hora};${p.setor};${p.responsavel};${p.produto};${p.quantidade};${p.codBarras||''};;${p.tipo};"${(p.motivo||'').replace(/"/g,'""')}";;REGISTRADO`); });
    faltasGondola.forEach(f=>{ const status = f.resolvido ? 'RESOLVIDO' : 'PENDENTE'; const feedback = (f.feedback||'').replace(/"/g,'""'); lines.push(`FALTA;${f.id};${f.data};${f.hora};${f.setor};${f.responsavel};${f.produto};;;;;;"${feedback}";${status}`); });
    informativos.forEach(i=>{ const msg = (i.mensagem||'').replace(/"/g,'""').replace(/\n/g,' '); lines.push(`INFORMATIVO;${i.id};${i.data};${i.hora};;;;${i.titulo};;;;;;"${msg}";ENVIADO`); });
    historicoServicos.forEach(h=>{ const desc = (h.descricao||'').replace(/"/g,'""').replace(/\n/g,' '); lines.push(`HISTORICO;${h.id};${h.data};${h.hora};;${h.autor};;;;;${h.tipo};"${desc}";;REGISTRADO`); });

    const csv = '\uFEFF' + lines.join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); 
    const a = document.createElement('a'); a.href = url; a.download = `relatorio_alkinda_${new Date().toISOString().slice(0,10)}.csv`; 
    document.body.appendChild(a); a.click(); a.remove(); 
    URL.revokeObjectURL(url);
    mostrarNotificacao('üì• Relat√≥rio CSV exportado com sucesso!');
}


/* ========================= INICIALIZA√á√ÉO ========================= */

// Inicializa√ß√£o ao carregar p√°gina
(async function init(){
    document.getElementById('logoImg').src = LOGO_PATH; 
    document.getElementById('headerLogo').src = LOGO_PATH;
    
    // Verifica se o usu√°rio j√° est√° logado (ex: deu F5)
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usu√°rio est√° logado
            console.log("Usu√°rio j√° logado:", user.displayName);
            usuarioAtual = user;
            funcionarioAtual = user.displayName ? user.displayName.toUpperCase() : user.email;
            
            // Pergunta se quer logar como gestor ou repositor
            // (Simulando o clique nos bot√µes)
            if (confirm("Voc√™ j√° est√° logado. Deseja ir para o painel de GESTOR? (Clique 'Cancelar' para ir como REPOSITOR)")) {
                tipoUsuario = 'gestor';
            } else {
                tipoUsuario = 'repositor';
            }
            iniciarSessao();
        } else {
            // Usu√°rio est√° deslogado
            console.log("Nenhum usu√°rio logado. Mostrando tela de login.");
            document.getElementById('loginBox').style.display='block';
            document.getElementById('mainScreen').style.display='none';
        }
    });
    
    const hoje = new Date().toISOString().split('T')[0]; 
    if(document.getElementById('filtroData')) {
        try { document.getElementById('filtroData').value = hoje; } catch (e) {}
    }
    
    console.log('%cüè™ Sistema Alkinda v4.0 - Cloud Version', 'color: #2F80ED; font-size: 20px; font-weight: bold;');
})();

/* Fecha modal clicando fora */
window.onclick = function(e){ 
    if(e.target.classList && e.target.classList.contains('modal')) {
        e.target.style.display = 'none'; 
    }
}
</script>
</body>
</html>
